<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Sales Tracker (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); min-height: 100vh; padding: 20px; color: #333; }
        
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        
        header { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; padding: 25px; text-align: center; }
        header h1 { font-size: 2.2em; margin-bottom: 5px; }
        header p { opacity: 0.9; font-size: 0.9em; }

        .content { padding: 30px; }

        /* Sections */
        .card { background: #fff5f2; border: 2px solid #ff8c42; border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        h2 { color: #ff5722; margin-bottom: 20px; font-size: 1.6em; display: flex; align-items: center; gap: 10px; }

        /* Inputs & Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { color: #d84315; font-weight: 600; margin-bottom: 5px; font-size: 0.85em; text-transform: uppercase; }
        input, select { padding: 10px; border: 2px solid #ffccbc; border-radius: 8px; font-size: 0.95em; transition: 0.3s; background: white; }
        input:focus, select:focus { outline: none; border-color: #ff5722; box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1); }
        
        .readonly-field { background: #ffe0d6; font-weight: bold; color: #d84315; cursor: default; }
        .calc-hint { font-size: 0.8em; color: #666; margin-top: 4px; font-weight: bold; }

        /* Buttons */
        .btn { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 87, 34, 0.3); }
        .btn-secondary { background: white; color: #ff5722; border: 2px solid #ff5722; }
        .btn-clear { background: #9e9e9e; background: linear-gradient(135deg, #757575 0%, #616161 100%); }
        .btn-invoice { background: linear-gradient(135deg, #ff5722 0%, #ff8f00 100%); box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border: 1px solid #ffccbc; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 0.8em; color: #757575; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card p { color: #ff5722; font-size: 1.4em; font-weight: 800; margin: 0; }
        
        /* Growth Colors */
        .growth-positive { color: #2e7d32; font-size: 0.8em; font-weight: bold; }
        .growth-negative { color: #c62828; font-size: 0.8em; font-weight: bold; }
        .growth-neutral { color: #757575; font-size: 0.8em; font-weight: bold; }

        /* Filter Section */
        .filter-section { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #ffccbc; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9em; }
        thead { background: #ff5722; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        tbody tr:hover { background: #fff5f2; }
        .delete-btn { background: #ffebee; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .delete-btn:hover { background: #ef5350; color: white; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; height: 320px; }

        /* Loader */
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ffccbc; border-top-color: #ff5722; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <h3 style="color: #ff5722;">Syncing Data...</h3>
    </div>

    <div class="container">
        <header>
            <h1>üçΩÔ∏è Restaurant Sales Tracker</h1>
            <p>Live Dashboard ‚Ä¢ Connected to Google Sheets</p>
        </header>

        <div class="content">
            
            <div class="card">
                <h2>‚ûï New Entry</h2>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Restaurant</label>
                            <select id="restro" required>
                                <option value="">Select Restaurant</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Total Amount (‚Çπ)</label>
                            <input type="number" id="totalAmount" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Item Price (‚Çπ)</label>
                            <input type="number" id="itemPrice" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Trans. Fees (%)</label>
                            <input type="number" id="transactionFees" step="0.01" value="1" required>
                            <span id="transFeeCalc" class="calc-hint">1% = ‚Çπ0.00</span>
                        </div>
                        <div class="form-group">
                            <label>Cust. Platform Fees</label>
                            <input type="number" id="customerPlatformFees" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Restro Platform Fees</label>
                            <input type="number" id="restroPlatformFees" step="0.01" value="2" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>Profit (Auto)</label>
                            <input type="number" id="profit" step="0.01" class="readonly-field" readonly>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">üîÑ Refresh</button>
                </form>
            </div>

            <div class="card" style="border-color: #ff5722; background-color: #fffaf9;">
                <h2 style="color: #ff5722;">üßæ Invoice PDF Generator</h2>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label>Select Restaurant</label>
                        <select id="invoiceRestro" required>
                            <option value="">Select Restaurant</option>
                            <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                            <option value="7 Star">7 Star</option>
                            <option value="Ethens">Ethens</option>
                            <option value="Royal Cafe">Royal Cafe</option>
                            <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                            <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                            <option value="Rajshahi">Rajshahi</option>
                            <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                            <option value="Raju Handi Meat">Raju Handi Meat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="invoiceStart">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="invoiceEnd">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button class="btn btn-invoice" onclick="generateInvoice()">Download Receipt</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üõµ Daily Riders</h2>
                <form id="riderSetupForm" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="riderDate" required>
                    </div>
                    <div class="form-group">
                        <label>Count</label>
                        <input type="number" id="numRiders" min="1" placeholder="0" style="width: 80px;" required>
                    </div>
                    <button type="submit" class="btn">Set Riders</button>
                </form>
                <div id="riderInputsContainer"></div>
                <div id="riderHistoryContainer" style="margin-top: 15px; font-size: 0.9em; color: #555;"></div>
            </div>

            <div class="card">
                <h2>üìä Analytics & Filters</h2>
                
                <div class="filter-section">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group">
                            <label>Filter by Date</label>
                            <input type="date" id="filterDate">
                        </div>
                        <div class="form-group">
                            <label>Filter by Restaurant</label>
                            <select id="filterRestro">
                                <option value="">All Restaurants</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                            </select>
                        </div>
                        <div class="form-group" style="justify-content: flex-end; flex-direction: row; gap: 10px;">
                            <button class="btn" onclick="updateDashboard()">Apply Filters</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card"><h3>Total Orders</h3><p id="totalEntries">0</p></div>
                    <div class="stat-card"><h3>Total Revenue</h3><p id="totalSales">‚Çπ0</p></div>
                    
                    <div class="stat-card" style="border-color: #ff5722; background: #fffbf9;">
                        <h3 style="color: #ff5722;">Proj. Month Revenue</h3>
                        <p id="projRevenue">‚Çπ0</p>
                    </div>

                    <div class="stat-card"><h3>Gross Profit</h3><p id="totalGrossProfit">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Rider Cost</h3><p id="totalRiderCost" style="color: #c62828;">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Net Profit</h3><p id="netProfit" style="color: #2e7d32;">‚Çπ0</p></div>
                    
                    <div class="stat-card"><h3>AOV (Avg Order Val)</h3><p id="aov">‚Çπ0</p></div>
                    
                    <div class="stat-card"><h3>Daily Order Growth</h3><div id="growthOrders" class="growth-neutral">‚Äî</div></div>
                    <div class="stat-card"><h3>Daily Rev Growth</h3><div id="growthRevenue" class="growth-neutral">‚Äî</div></div>
                    <div class="stat-card"><h3>Daily Profit Growth</h3><div id="growthProfit" class="growth-neutral">‚Äî</div></div>
                </div>

                <div class="charts-grid">
                    <div class="chart-box"><canvas id="restroChart"></canvas></div>
                    <div class="chart-box"><canvas id="trendChart"></canvas></div>
                </div>

                <h3 style="margin-top: 40px;">Detailed Records</h3>
                <div class="table-container">
                    <div id="tableContainer" style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwnIWaxlQnDN6J0NAVvuwvC48rhgwc42pikCjDx-0dzy2GetuGnYNmXQLwJkxLMat8l/exec';
        // ============================================================

        let allSalesData = [];
        let allRiderData = {}; 
        let restroChartInstance = null;
        let trendChartInstance = null;

        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        async function loadData() {
            showLoader();
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                
                allSalesData = data.sales.map(item => {
                    item.date = normalizeDate(item.date);
                    return item;
                });

                allRiderData = {};
                for (let dateKey in data.riders) {
                    const cleanDate = normalizeDate(dateKey);
                    allRiderData[cleanDate] = data.riders[dateKey];
                }
                
                updateDashboard(); 
                renderRiderHistoryUI();
            } catch (e) {
                console.error(e);
                alert("Connection Error. Check console.");
            }
            hideLoader();
        }

        function normalizeDate(rawDate) {
            if (!rawDate) return "";
            if (typeof rawDate === 'string' && rawDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return rawDate;
            }
            try {
                const d = new Date(rawDate);
                const offset = d.getTimezoneOffset() * 60000;
                const localDate = new Date(d.getTime() - offset);
                return localDate.toISOString().split('T')[0];
            } catch(e) {
                return rawDate;
            }
        }

        async function sendToSheet(payload) {
            showLoader();
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                setTimeout(() => { alert("Saved!"); loadData(); }, 1500);
            } catch (e) {
                console.error(e);
                alert("Save Failed.");
                hideLoader();
            }
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const filterDate = document.getElementById('filterDate').value;
            const filterRestro = document.getElementById('filterRestro').value;

            // 1. Filter Sales
            let filteredSales = allSalesData.filter(item => {
                const dateMatch = filterDate ? item.date === filterDate : true;
                const restroMatch = filterRestro ? item.restro === filterRestro : true;
                return dateMatch && restroMatch;
            });

            // 2. Rider Costs
            let relevantRiderCost = 0;
            if (filterDate) {
                if(allRiderData[filterDate]) relevantRiderCost = allRiderData[filterDate].reduce((sum, r) => sum + r.wage, 0);
            } else {
                Object.values(allRiderData).forEach(dayList => dayList.forEach(r => relevantRiderCost += r.wage));
            }

            // 3. Stats
            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalGross = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const netProfit = totalGross - relevantRiderCost;
            const entryCount = filteredSales.length;
            const aov = entryCount > 0 ? (totalRevenue / entryCount) : 0;

            calculateGrowthMetrics(filteredSales);
            calculateMonthlyProjection(allSalesData);

            document.getElementById('totalEntries').textContent = entryCount;
            document.getElementById('totalSales').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            document.getElementById('totalGrossProfit').textContent = `‚Çπ${totalGross.toLocaleString()}`;
            document.getElementById('totalRiderCost').textContent = `‚Çπ${relevantRiderCost.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `‚Çπ${netProfit.toLocaleString()}`;
            document.getElementById('aov').textContent = `‚Çπ${aov.toFixed(0)}`;

            renderTable(filteredSales);
            renderCharts(filteredSales);
        }

        function calculateMonthlyProjection(data) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); 
            const currentDay = now.getDate();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            const currentMonthSales = data.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const currentMonthRevenue = currentMonthSales.reduce((sum, s) => sum + s.totalAmount, 0);

            let projected = 0;
            if (currentDay > 0) {
                projected = (currentMonthRevenue / currentDay) * daysInMonth;
            }

            document.getElementById('projRevenue').textContent = `‚Çπ${projected.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        }

        // --- UPDATED PDF GENERATOR (SMART FIX) ---
        function generateInvoice() {
            const restroName = document.getElementById('invoiceRestro').value;
            const startDate = document.getElementById('invoiceStart').value;
            const endDate = document.getElementById('invoiceEnd').value;

            if (!restroName || !startDate || !endDate) {
                alert("Please select Restaurant, Start Date, and End Date.");
                return;
            }

            const invoiceData = allSalesData.filter(item => {
                return item.restro === restroName && item.date >= startDate && item.date <= endDate;
            });

            if (invoiceData.length === 0) {
                alert("No sales found for this criteria.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // 1. Header
            doc.setFillColor(255, 87, 34); // #ff5722
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Khanago : RAAOSKG Techspark LLP", 14, 25);

            doc.setFontSize(20);
            doc.text("PAYOUT STATEMENT", 195, 25, { align: "right" });

            // 2. Info
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            doc.setFont("helvetica", "bold");
            doc.text("BILL TO:", 14, 55);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text(restroName, 14, 62);

            doc.setFontSize(10);
            const rightX = 140;
            doc.text(`Date Range: ${startDate} to ${endDate}`, rightX, 55);
            doc.text(`Generated On: ${new Date().toLocaleDateString()}`, rightX, 61);

            // 3. Table Logic (SMART FIX)
            let totalItemAmt = 0;
            let totalRestroFee = 0;
            let totalTransFee = 0;
            let totalPayout = 0;

            const tableRows = invoiceData.map(row => {
                
                let rawRate = row.transactionFees;
                let effectiveRate, displayPercent;

                // --- SMART LOGIC ---
                // If the stored value is small (like 0.01), assume it's a decimal format for 1%.
                // If it's a whole number (like 1), assume it's a percentage format for 1%.
                if (rawRate < 1 && rawRate > 0) {
                    effectiveRate = rawRate;        // 0.01 is already the multiplier
                    displayPercent = (rawRate * 100).toFixed(0); // Display as 1
                } else {
                    effectiveRate = rawRate / 100;  // 1 becomes 0.01
                    displayPercent = rawRate;       // Display as 1
                }

                const transFeeAmt = row.itemPrice * effectiveRate;
                const payout = row.itemPrice - row.restroPlatformFees - transFeeAmt;

                totalItemAmt += row.itemPrice;
                totalRestroFee += row.restroPlatformFees;
                totalTransFee += transFeeAmt;
                totalPayout += payout;

                return [
                    row.date,
                    `${row.itemPrice.toFixed(2)}`,
                    `${row.restroPlatformFees.toFixed(2)}`,
                    `${transFeeAmt.toFixed(2)} (${displayPercent}%)`, // FIXED DISPLAY
                    `${payout.toFixed(2)}`
                ];
            });

            // 4. Generate Table
            doc.autoTable({
                startY: 75,
                head: [['Date', 'Item Amount (Rs)', 'Platform Fee', 'Trans. Fee', 'Net Payable']],
                body: tableRows,
                theme: 'grid',
                headStyles: { 
                    fillColor: [255, 87, 34], 
                    textColor: [255, 255, 255], 
                    fontStyle: 'bold' 
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    4: { fontStyle: 'bold', textColor: [40, 40, 40] }
                },
                styles: { fontSize: 10, cellPadding: 4 }
            });

            // 5. Summary Footer
            const finalY = doc.lastAutoTable.finalY + 10;
            const summaryX = 120; 

            doc.setFontSize(11);
            doc.setTextColor(80, 80, 80);
            doc.text(`Total Item Sales:`, summaryX, finalY);
            doc.text(`Rs ${totalItemAmt.toFixed(2)}`, 195, finalY, { align: "right" });

            doc.text(`Total Fees Deducted:`, summaryX, finalY + 7);
            doc.text(`- Rs ${(totalRestroFee + totalTransFee).toFixed(2)}`, 195, finalY + 7, { align: "right" });

            doc.setFillColor(255, 245, 242); 
            doc.rect(summaryX - 5, finalY + 12, 90, 12, 'F');

            doc.setTextColor(255, 87, 34);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`Net Payout:`, summaryX, finalY + 20);
            doc.text(`Rs ${totalPayout.toFixed(2)}`, 195, finalY + 20, { align: "right" });

            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.setFont("helvetica", "italic");
            doc.text("Thank you for partnering with Khanago.", 14, 280);

            doc.save(`Payout_${restroName}_${startDate}.pdf`);
        }

        // --- Growth Metrics ---
        function calculateGrowthMetrics(data) {
            const dailyAgg = {};
            data.forEach(s => {
                if(!dailyAgg[s.date]) dailyAgg[s.date] = { orders: 0, revenue: 0, profit: 0 };
                dailyAgg[s.date].orders++;
                dailyAgg[s.date].revenue += s.totalAmount;
                dailyAgg[s.date].profit += s.profit;
            });

            const sortedDates = Object.keys(dailyAgg).sort();
            
            if(sortedDates.length < 2) {
                document.getElementById('growthOrders').innerHTML = '‚Äî';
                document.getElementById('growthRevenue').innerHTML = '‚Äî';
                document.getElementById('growthProfit').innerHTML = '‚Äî';
                return;
            }

            const today = dailyAgg[sortedDates[sortedDates.length - 1]];
            const yesterday = dailyAgg[sortedDates[sortedDates.length - 2]];

            updateGrowthUI('growthOrders', today.orders, yesterday.orders, '');
            updateGrowthUI('growthRevenue', today.revenue, yesterday.revenue, '‚Çπ');
            updateGrowthUI('growthProfit', today.profit, yesterday.profit, '‚Çπ');
        }

        function updateGrowthUI(elementId, current, previous, prefix) {
            if(previous === 0) return;
            const growth = ((current - previous) / previous) * 100;
            const el = document.getElementById(elementId);
            
            let icon = '‚Äî';
            let colorClass = 'growth-neutral';

            if(growth > 0) { icon = '‚ñ≤'; colorClass = 'growth-positive'; }
            if(growth < 0) { icon = '‚ñº'; colorClass = 'growth-negative'; }

            el.innerHTML = `<span class="${colorClass}">${icon} ${growth.toFixed(1)}%</span>`;
        }

        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterRestro').value = '';
            updateDashboard();
        }

        function renderTable(data) {
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
            let html = `<table><thead><tr><th>Date</th><th>Restaurant</th><th>Total</th><th>Profit</th><th>Action</th></tr></thead><tbody>`;
            if(sorted.length === 0) html += '<tr><td colspan="5" style="text-align:center; padding:20px;">No records found</td></tr>';
            sorted.slice(0, 100).forEach(row => {
                html += `<tr>
                    <td>${row.date}</td>
                    <td>${row.restro}</td>
                    <td>‚Çπ${row.totalAmount}</td>
                    <td style="color:#ff5722; font-weight:bold;">‚Çπ${row.profit.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteSale('${row.id}')">Del</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        function renderCharts(data) {
            const ctxRestro = document.getElementById('restroChart').getContext('2d');
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            
            const restroAgg = {};
            const dateAgg = {};

            data.forEach(item => {
                restroAgg[item.restro] = (restroAgg[item.restro] || 0) + item.profit;
                dateAgg[item.date] = (dateAgg[item.date] || 0) + item.profit;
            });

            const sortedRestros = Object.entries(restroAgg).sort((a,b) => b[1] - a[1]).slice(0, 8);
            const sortedDates = Object.keys(dateAgg).sort();

            if(restroChartInstance) restroChartInstance.destroy();
            restroChartInstance = new Chart(ctxRestro, {
                type: 'bar',
                data: {
                    labels: sortedRestros.map(x => x[0]),
                    datasets: [{ label: 'Profit (‚Çπ)', data: sortedRestros.map(x => x[1]), backgroundColor: '#ff8c42', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Top Restaurants by Profit'} } }
            });

            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{ label: 'Daily Profit (‚Çπ)', data: sortedDates.map(d => dateAgg[d]), borderColor: '#ff5722', backgroundColor: 'rgba(255,87,34,0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Profit Trend'} } }
            });
        }

        // --- FORM & HELPERS ---
        function calcProfit() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const rate = parseFloat(document.getElementById('transactionFees').value) || 0;
            const restroFee = parseFloat(document.getElementById('restroPlatformFees').value) || 0;
            
            // Calculate Amount for Display
            const transFeeAmt = (price * rate) / 100;
            document.getElementById('transFeeCalc').innerText = `${rate}% = ‚Çπ${transFeeAmt.toFixed(2)}`;

            // Profit = My Earnings (RestroFee + TransFeeSlice) + (Total - Price [which is Delivery Charge])
            // Note: Adjust this logic if 'profit' has a different business definition for you.
            // Currently: Profit = (CustomerTotal - ItemPrice) + RestroFee + MyCutOfItemPrice
            const profit = (total - price) + restroFee + transFeeAmt;
            
            document.getElementById('profit').value = profit.toFixed(2);
        }
        ['totalAmount','itemPrice','transactionFees'].forEach(id => document.getElementById(id).addEventListener('input', calcProfit));

        document.getElementById('salesForm').addEventListener('submit', e => {
            e.preventDefault();
            const entry = {
                id: Date.now(), date: document.getElementById('date').value,
                restro: document.getElementById('restro').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                itemPrice: parseFloat(document.getElementById('itemPrice').value),
                transactionFees: parseFloat(document.getElementById('transactionFees').value),
                customerPlatformFees: parseFloat(document.getElementById('customerPlatformFees').value),
                restroPlatformFees: parseFloat(document.getElementById('restroPlatformFees').value),
                profit: parseFloat(document.getElementById('profit').value)
            };
            sendToSheet({ action: 'addSale', entry: entry });
            const d = document.getElementById('date').value;
            e.target.reset();
            document.getElementById('date').value = d;
            document.getElementById('transactionFees').value = 1; 
            document.getElementById('restroPlatformFees').value = 2;
        });

        document.getElementById('riderSetupForm').addEventListener('submit', e => {
            e.preventDefault();
            const date = document.getElementById('riderDate').value;
            const count = document.getElementById('numRiders').value;
            let html = `<div style="margin:15px 0; background:white; padding:10px; border:1px solid #ddd;"><h4>Enter ${count} Riders for ${date}</h4>`;
            for(let i=0; i<count; i++) {
                html += `<div style="display:flex; gap:10px; margin-bottom:5px;">
                    <input type="text" placeholder="Name" class="r-name" style="flex:2">
                    <input type="number" placeholder="Wage" class="r-wage" style="flex:1">
                </div>`;
            }
            html += `<button class="btn" onclick="saveRiders('${date}')">Save</button> <button class="btn btn-clear" onclick="this.parentNode.remove()">Cancel</button></div>`;
            document.getElementById('riderInputsContainer').innerHTML = html;
        });

        function saveRiders(date) {
            const names = document.querySelectorAll('.r-name');
            const wages = document.querySelectorAll('.r-wage');
            let riders = [];
            names.forEach((n,i) => { if(n.value && wages[i].value) riders.push({name:n.value, wage:parseFloat(wages[i].value)}) });
            if(riders.length) {
                sendToSheet({ action:'saveRiders', date:date, riders:riders });
                document.getElementById('riderInputsContainer').innerHTML = '';
            }
        }

        function renderRiderHistoryUI() {
            const container = document.getElementById('riderHistoryContainer');
            if(Object.keys(allRiderData).length === 0) { container.innerHTML = ''; return; }
            let html = '<strong>History:</strong> ';
            const dates = Object.keys(allRiderData).sort().reverse().slice(0, 5);
            dates.forEach(d => {
                const total = allRiderData[d].reduce((s,r) => s+r.wage, 0);
                html += `<span style="background:white; border:1px solid #ccc; padding:2px 8px; margin-right:5px; border-radius:4px;">${d}: ‚Çπ${total} <span style="cursor:pointer; color:red;" onclick="deleteRiders('${d}')">x</span></span>`;
            });
            container.innerHTML = html;
        }

        function deleteSale(id) { if(confirm("Delete?")) sendToSheet({action:'deleteSale', id:id}); }
        function deleteRiders(date) { if(confirm("Delete riders for "+date+"?")) sendToSheet({action:'deleteRiders', date:date}); }

        // Init
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('riderDate').valueAsDate = new Date();
        loadData();
    </script>
</body>
</html>
