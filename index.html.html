<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khanago Sales Tracker (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); min-height: 10vh; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        header { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; padding: 25px; text-align: center; }
        header h1 { font-size: 2.2em; margin-bottom: 5px; }
        header p { opacity: 0.9; font-size: 0.9em; }
        .content { padding: 30px; }
        .card { background: #fff5f2; border: 2px solid #ff8c42; border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        h2 { color: #ff5722; margin-bottom: 20px; font-size: 1.6em; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { color: #d84315; font-weight: 600; margin-bottom: 5px; font-size: 0.85em; text-transform: uppercase; }
        input, select { padding: 10px; border: 2px solid #ffccbc; border-radius: 8px; font-size: 0.95em; transition: 0.3s; background: white; }
        input:focus, select:focus { outline: none; border-color: #ff5722; box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1); }
        .readonly-field { background: #ffe0d6; font-weight: bold; color: #d84315; cursor: default; }
        .calc-hint { font-size: 0.8em; color: #666; margin-top: 4px; font-weight: bold; }
        .btn { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 87, 34, 0.3); }
        .btn-secondary { background: white; color: #ff5722; border: 2px solid #ff5722; }
        .btn-clear { background: linear-gradient(135deg, #757575 0%, #616161 100%); }
        .btn-invoice { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); box-shadow: 0 4px 10px rgba(44, 62, 80, 0.3); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border: 1px solid #ffccbc; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 0.8em; color: #757575; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card p { color: #ff5722; font-size: 1.4em; font-weight: 800; margin: 0; }
        .growth-positive { color: #2e7d32; font-size: 0.8em; font-weight: bold; }
        .growth-negative { color: #c62828; font-size: 0.8em; font-weight: bold; }
        .growth-neutral { color: #757575; font-size: 0.8em; font-weight: bold; }
        .filter-section { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #ffccbc; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9em; }
        thead { background: #ff5722; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        tbody tr:hover { background: #fff5f2; }
        .delete-btn { background: #ffebee; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .delete-btn:hover { background: #ef5350; color: white; }
        .charts-grid-top { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 30px; margin-bottom: 20px; }
        .charts-grid-bottom { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; height: 320px; }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #ff5722; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="color: #ff5722;">Syncing Supabase...</h3>
    </div>

    <div class="container">
        <header>
            <h1>üçΩÔ∏è Khanago Sales Tracker</h1>
            <p>Live Dashboard ‚Ä¢ Connected to Supabase</p>
        </header>

        <div class="content">
            <div class="card">
                <h2>‚ûï New Entry</h2>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                        <div class="form-group">
                            <label>Restaurant</label>
                            <select id="restro" required>
                                <option value="">Select Restaurant</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                                <option value="Shifa Biryani">Shifa Biryani</option>
                                <option value="Star Biryani">Star Biryani</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Total Amount (‚Çπ)</label><input type="number" id="totalAmount" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group"><label>Item Price (‚Çπ)</label><input type="number" id="itemPrice" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group">
                            <label>Trans. Fees (%)</label>
                            <input type="number" id="transactionFees" step="0.01" value="1" required>
                            <span id="transFeeCalc" class="calc-hint">1% = ‚Çπ0.00</span>
                        </div>
                        <div class="form-group">
                            <label>Commission (%)</label>
                            <input type="number" id="commission" step="0.01" value="0" required>
                            <span id="commissionCalc" class="calc-hint">0% = ‚Çπ0.00</span>
                        </div>
                        <div class="form-group"><label>Cust. Platform Fees</label><input type="number" id="customerPlatformFees" step="0.01" value="0" required></div>
                        <div class="form-group"><label>Restro Platform Fees</label><input type="number" id="restroPlatformFees" step="0.01" value="2" class="readonly-field" readonly></div>
                        <div class="form-group"><label>Profit (Auto)</label><input type="number" id="profit" step="0.01" class="readonly-field" readonly></div>
                    </div>
                    <button type="submit" class="btn">Add Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">üîÑ Refresh</button>
                </form>
            </div>

            <div class="card" style="border-color: #2c3e50; background-color: #f8f9fa;">
                <h2 style="color: #2c3e50;">üßæ Invoice PDF Generator</h2>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label>Select Restaurant</label>
                        <select id="invoiceRestro">
                            <option value="">Select Restaurant</option>
                            <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                            <option value="7 Star">7 Star</option>
                            <option value="Ethens">Ethens</option>
                            <option value="Royal Cafe">Royal Cafe</option>
                            <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                            <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                            <option value="Rajshahi">Rajshahi</option>
                            <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                            <option value="Raju Handi Meat">Raju Handi Meat</option>
                            <option value="Shifa Biryani">Shifa Biryani</option>
                            <option value="Star Biryani">Star Biryani</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Start Date</label><input type="date" id="invoiceStart"></div>
                    <div class="form-group"><label>End Date</label><input type="date" id="invoiceEnd"></div>
                    <div class="form-group" style="justify-content: flex-end;"><button class="btn btn-invoice" onclick="generateInvoice()">Download Receipt</button></div>
                </div>
            </div>

            <div class="card">
                <h2>üõµ Daily Riders</h2>
                <form id="riderSetupForm" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                    <div class="form-group"><label>Date</label><input type="date" id="riderDate" required></div>
                    <div class="form-group"><label>Count</label><input type="number" id="numRiders" min="1" placeholder="0" style="width: 80px;" required></div>
                    <button type="submit" class="btn">Set Riders</button>
                </form>
                <div id="riderInputsContainer"></div>
                <div id="riderHistoryContainer" style="margin-top: 15px; font-size: 0.9em; color: #555;"></div>
            </div>

            <div class="card" style="border-color: #4a6baf; background-color: #f8f9ff;">
                <h2 style="color: #4a6baf;">üìà Weekly Growth</h2>
                <div class="stats" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <h3>Revenue Growth</h3>
                        <div id="weeklyRevenueGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">‚Äî</div>
                        <p class="text-muted" id="weeklyRevenuePeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Order Growth</h3>
                        <div id="weeklyOrderGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">‚Äî</div>
                        <p class="text-muted" id="weeklyOrderPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>AOV Growth</h3>
                        <div id="weeklyAovGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">‚Äî</div>
                        <p class="text-muted" id="weeklyAovPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Rev/Day Growth</h3>
                        <div id="weeklyAvgRevGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">‚Äî</div>
                        <p class="text-muted" id="weeklyAvgRevPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Analytics & Filters</h2>
                <div class="filter-section">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group"><label>From Date</label><input type="date" id="filterStartDate"></div>
                        <div class="form-group"><label>To Date</label><input type="date" id="filterEndDate"></div>
                        <div class="form-group">
                            <label>Filter by Restaurant</label>
                            <select id="filterRestro">
                                <option value="">All Restaurants</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                                <option value="Shifa Biryani">Shifa Biryani</option>
                                <option value="Star Biryani">Star Biryani</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="justify-content: flex-end; flex-direction: row; gap: 10px;">
                            <button class="btn" onclick="updateDashboard()">Apply Filters</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card"><h3>Total Orders</h3><p id="totalEntries">0</p></div>
                    <div class="stat-card"><h3>Total Revenue</h3><p id="totalSales">‚Çπ0</p></div>
                    <div class="stat-card" style="border-color: #ff5722; background: #fffbf9;"><h3 style="color: #ff5722;">Proj. Month Revenue</h3><p id="projRevenue">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Gross Profit</h3><p id="totalGrossProfit">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Rider Cost</h3><p id="totalRiderCost" style="color: #c62828;">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Net Profit</h3><p id="netProfit" style="color: #2e7d32;">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Net Margin</h3><p id="netMargin" style="color: #2e7d32;">0%</p></div>
                    <div class="stat-card"><h3>Avg Orders/Day</h3><p id="avgOrdersPerDay">0</p></div>
                    <div class="stat-card"><h3>Avg Revenue/Day</h3><p id="avgRevenuePerDay">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Avg Profit/Order</h3><p id="avgProfitPerOrder">‚Çπ0</p></div>
                    <div class="stat-card"><h3>AOV (Order Val)</h3><p id="aov">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Daily Order Growth</h3><div id="growthOrders" class="growth-neutral">‚Äî</div></div>
                    <div class="stat-card"><h3>Daily Rev Growth</h3><div id="growthRevenue" class="growth-neutral">‚Äî</div></div>
                    <div class="stat-card"><h3>Daily Profit Growth</h3><div id="growthProfit" class="growth-neutral">‚Äî</div></div>
                </div>

                <div class="charts-grid-top"><div class="chart-box"><canvas id="ordersChart"></canvas></div></div>
                <div class="charts-grid-bottom">
                    <div class="chart-box"><canvas id="restroChart"></canvas></div>
                    <div class="chart-box"><canvas id="trendChart"></canvas></div>
                </div>

                <h3 style="margin-top: 40px;">Detailed Records</h3>
                <div class="table-container">
                    <div id="tableContainer" style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aHJhaHVpb25zdnp5dXpkdGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzA4MTcsImV4cCI6MjA4MTY0NjgxN30.ypEmevr3XTuyNtJxUSSqCplAdcru9fkE3q15HOQHrVY';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allSalesData = [];
        let allRiderData = {};
        let restroChartInstance = null, trendChartInstance = null, ordersChartInstance = null;

        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        const safeSetHTML = (id, html) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = html;
        };

        const safeSetText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        };

        async function loadData() {
            showLoader();
            try {
                const { data: sales, error: sErr } = await _supabase.from('sales').select('*');
                if (sErr) throw sErr;
                
                allSalesData = sales.map(s => ({
                    id: s.id,
                    date: s.Date,
                    restro: s.Restaurant,
                    totalAmount: s["Total Amount"],
                    itemPrice: s["Item Price"],
                    transactionFees: s["Transaction Fees %"],
                    commission: s["Commission %"],
                    customerPlatformFees: s["Customer Platform Fees"],
                    restroPlatformFees: s["Restro Platform Fees"],
                    profit: s.Profit
                }));

                const { data: riders, error: rErr } = await _supabase.from('riders').select('*');
                if (rErr) throw rErr;

                allRiderData = riders.reduce((acc, r) => {
                    if (!acc[r.Date]) acc[r.Date] = [];
                    acc[r.Date].push({ name: r["Rider Name"], wage: r.WAGE, id: r.id });
                    return acc;
                }, {});

                updateDashboard();
                renderRiderHistoryUI();
            } catch (e) {
                console.error(e);
                alert("Supabase Error: " + e.message);
            }
            hideLoader();
        }

        async function addSaleEntry(entry) {
            showLoader();
            const { error } = await _supabase.from('sales').insert([{
                "Date": entry.date,
                "Restaurant": entry.restro,
                "Total Amount": entry.totalAmount,
                "Item Price": entry.itemPrice,
                "Transaction Fees %": entry.transactionFees,
                "Transaction Fees Amount": (entry.itemPrice * entry.transactionFees) / 100,
                "Customer Platform Fees": entry.customerPlatformFees,
                "Restro Platform Fees": entry.restroPlatformFees,
                "Profit": entry.profit,
                "Commission %": entry.commission,
                "Commission Amt": (entry.itemPrice * entry.commission) / 100
            }]);
            
            if (error) alert(error.message);
            else { alert("Sale Saved!"); loadData(); }
            hideLoader();
        }

        async function saveRiders(date, riders) {
            showLoader();
            const rows = riders.map(r => ({
                "Date": date,
                "Rider Name": r.name,
                "WAGE": r.wage
            }));
            const { error } = await _supabase.from('riders').insert(rows);
            if (error) alert(error.message);
            else { alert("Riders Saved!"); loadData(); }
            hideLoader();
        }

        async function deleteSale(id) {
            if(!confirm("Delete this sale?")) return;
            showLoader();
            const { error } = await _supabase.from('sales').delete().eq('id', id);
            if (error) alert(error.message);
            else loadData();
            hideLoader();
        }

        async function deleteRiders(date) {
            if(!confirm("Delete all riders for " + date + "?")) return;
            showLoader();
            const { error } = await _supabase.from('riders').delete().eq('Date', date);
            if (error) alert(error.message);
            else loadData();
            hideLoader();
        }

        function updateDashboard() {
            const filterStart = document.getElementById('filterStartDate').value;
            const filterEnd = document.getElementById('filterEndDate').value;
            const filterRestro = document.getElementById('filterRestro').value;

            let filteredSales = allSalesData.filter(item => {
                const startMatch = filterStart ? item.date >= filterStart : true;
                const endMatch = filterEnd ? item.date <= filterEnd : true;
                const restroMatch = filterRestro ? item.restro === filterRestro : true;
                return startMatch && endMatch && restroMatch;
            });

            let relevantRiderCost = 0;
            Object.keys(allRiderData).forEach(date => {
                const startMatch = filterStart ? date >= filterStart : true;
                const endMatch = filterEnd ? date <= filterEnd : true;
                if (startMatch && endMatch) {
                    allRiderData[date].forEach(r => relevantRiderCost += r.wage);
                }
            });

            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalGross = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const netProfit = totalGross - relevantRiderCost;
            const entryCount = filteredSales.length;
            const uniqueDates = new Set(filteredSales.map(s => s.date)).size || 1;
            
            safeSetText('totalEntries', entryCount);
            safeSetText('totalSales', `‚Çπ${totalRevenue.toLocaleString()}`);
            safeSetText('totalGrossProfit', `‚Çπ${totalGross.toLocaleString()}`);
            safeSetText('totalRiderCost', `‚Çπ${relevantRiderCost.toLocaleString()}`);
            safeSetText('netProfit', `‚Çπ${netProfit.toLocaleString()}`);
            safeSetText('avgOrdersPerDay', (entryCount / uniqueDates).toFixed(1));
            safeSetText('avgRevenuePerDay', `‚Çπ${(totalRevenue / uniqueDates).toFixed(0)}`);
            safeSetText('netMargin', `${(totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0).toFixed(1)}%`);
            safeSetText('avgProfitPerOrder', `‚Çπ${(entryCount > 0 ? netProfit / entryCount : 0).toFixed(1)}`);
            safeSetText('aov', `‚Çπ${(entryCount > 0 ? totalRevenue / entryCount : 0).toFixed(0)}`);

            calculateGrowthMetrics(filteredSales);
            calculateMonthlyProjection(allSalesData);
            renderTable(filteredSales);
            renderCharts(filteredSales);
        }

        function calculateMonthlyProjection(data) {
            const now = new Date(), currentYear = now.getFullYear(), currentMonth = now.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const currSales = data.filter(s => {
                const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            const uniqueDays = new Set(currSales.map(s => s.date)).size;
            const rev = currSales.reduce((s, x) => s + x.totalAmount, 0);
            const projected = uniqueDays > 0 ? (rev / uniqueDays) * daysInMonth : 0;
            safeSetText('projRevenue', `‚Çπ${projected.toLocaleString(undefined, {maximumFractionDigits: 0})}`);
        }

        function renderTable(data) {
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
            let html = `<table><thead><tr><th>Date</th><th>Restaurant</th><th>Total</th><th>Profit</th><th>Action</th></tr></thead><tbody>`;
            if(sorted.length === 0) html += '<tr><td colspan="5" style="text-align:center; padding:20px;">No records found</td></tr>';
            sorted.slice(0, 100).forEach(row => {
                html += `<tr><td>${row.date}</td><td>${row.restro}</td><td>‚Çπ${row.totalAmount}</td><td style="color:#ff5722; font-weight:bold;">‚Çπ${row.profit.toFixed(2)}</td><td><button class="delete-btn" onclick="deleteSale('${row.id}')">Del</button></td></tr>`;
            });
            safeSetHTML('tableContainer', html + '</tbody></table>');
        }

        function formatChartDate(dateString) {
            const parts = dateString.split('-');
            const localDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); 
            return `${localDate.toLocaleDateString('en-US', { weekday: 'short' })} ${localDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' })}`;
        }

        function renderCharts(data) {
            const ordersChartEl = document.getElementById('ordersChart');
            const restroChartEl = document.getElementById('restroChart');
            const trendChartEl = document.getElementById('trendChart');

            if(!ordersChartEl || !restroChartEl || !trendChartEl) return;

            const ctxRestro = restroChartEl.getContext('2d');
            const ctxTrend = trendChartEl.getContext('2d');
            const ctxOrders = ordersChartEl.getContext('2d');
            const restroAgg = {}, dateAgg = {}, dailyOrderCount = {}; 

            data.forEach(item => {
                restroAgg[item.restro] = (restroAgg[item.restro] || 0) + item.profit;
                dateAgg[item.date] = (dateAgg[item.date] || 0) + item.profit;
                dailyOrderCount[item.date] = (dailyOrderCount[item.date] || 0) + 1; 
            });

            const sortedRestros = Object.entries(restroAgg).sort((a,b) => b[1] - a[1]).slice(0, 8);
            const sortedDates = Object.keys(dateAgg).sort();

            if(restroChartInstance) restroChartInstance.destroy();
            restroChartInstance = new Chart(ctxRestro, {
                type: 'bar',
                data: { labels: sortedRestros.map(x => x[0]), datasets: [{ label: 'Profit (‚Çπ)', data: sortedRestros.map(x => x[1]), backgroundColor: '#ff8c42', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Top Restaurants by Profit'} } }
            });

            if(ordersChartInstance) ordersChartInstance.destroy();
            ordersChartInstance = new Chart(ctxOrders, {
                type: 'bar',
                data: { labels: sortedDates.map(formatChartDate), datasets: [{ label: 'Daily Orders', data: sortedDates.map(d => dailyOrderCount[d]), backgroundColor: '#ff5722', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Daily Orders by Date'} } }
            });

            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctxTrend, {
                type: 'line',
                data: { labels: sortedDates, datasets: [{ label: 'Daily Profit (‚Çπ)', data: sortedDates.map(d => dateAgg[d]), borderColor: '#ff5722', backgroundColor: 'rgba(255,87,34,0.1)', fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Profit Trend'} } }
            });
        }

        function calcProfit() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const rate = parseFloat(document.getElementById('transactionFees').value) || 0;
            const commission = parseFloat(document.getElementById('commission').value) || 0;
            const restroFee = parseFloat(document.getElementById('restroPlatformFees').value) || 0;
            const transFeeAmt = (price * rate) / 100, commissionAmt = (price * commission) / 100;
            safeSetText('transFeeCalc', `${rate}% = ‚Çπ${transFeeAmt.toFixed(2)}`);
            safeSetText('commissionCalc', `${commission}% = ‚Çπ${commissionAmt.toFixed(2)}`);
            document.getElementById('profit').value = ((total - price) + restroFee + transFeeAmt + commissionAmt).toFixed(2);
        }
        ['totalAmount','itemPrice','transactionFees','commission'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', calcProfit);
        });

        document.getElementById('salesForm').addEventListener('submit', e => {
            e.preventDefault();
            const entry = {
                date: document.getElementById('date').value,
                restro: document.getElementById('restro').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                itemPrice: parseFloat(document.getElementById('itemPrice').value),
                transactionFees: parseFloat(document.getElementById('transactionFees').value),
                commission: parseFloat(document.getElementById('commission').value),
                customerPlatformFees: parseFloat(document.getElementById('customerPlatformFees').value),
                restroPlatformFees: parseFloat(document.getElementById('restroPlatformFees').value),
                profit: parseFloat(document.getElementById('profit').value)
            };
            addSaleEntry(entry);
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('transactionFees').value = 1; 
            document.getElementById('commission').value = 0; 
            document.getElementById('restroPlatformFees').value = 2;
        });

        document.getElementById('riderSetupForm').addEventListener('submit', e => {
            e.preventDefault();
            const date = document.getElementById('riderDate').value, count = document.getElementById('numRiders').value;
            let html = `<div style="margin:15px 0; background:white; padding:10px; border:1px solid #ddd;"><h4>Enter ${count} Riders for ${date}</h4>`;
            for(let i=0; i<count; i++) {
                html += `<div style="display:flex; gap:10px; margin-bottom:5px;"><input type="text" placeholder="Name" class="r-name" style="flex:2"><input type="number" placeholder="Wage" class="r-wage" style="flex:1"></div>`;
            }
            html += `<button class="btn" onclick="handleSaveRiders('${date}')">Save</button> <button class="btn btn-clear" onclick="this.parentNode.remove()">Cancel</button></div>`;
            safeSetHTML('riderInputsContainer', html);
        });

        function handleSaveRiders(date) {
            const names = document.querySelectorAll('.r-name'), wages = document.querySelectorAll('.r-wage');
            let riders = [];
            names.forEach((n,i) => { if(n.value && wages[i].value) riders.push({name:n.value, wage:parseFloat(wages[i].value)}) });
            if(riders.length) { saveRiders(date, riders); safeSetHTML('riderInputsContainer', ''); }
        }

        function renderRiderHistoryUI() {
            if(Object.keys(allRiderData).length === 0) { safeSetHTML('riderHistoryContainer', ''); return; }
            let html = '<strong>History:</strong> ';
            Object.keys(allRiderData).sort().reverse().slice(0, 5).forEach(d => {
                const total = allRiderData[d].reduce((s,r) => s+r.wage, 0);
                html += `<span style="background:white; border:1px solid #ccc; padding:2px 8px; margin-right:5px; border-radius:4px;">${d}: ‚Çπ${total} <span style="cursor:pointer; color:red;" onclick="deleteRiders('${d}')">x</span></span>`;
            });
            safeSetHTML('riderHistoryContainer', html);
        }

        function updateGrowthUI(elementId, current, previous, suffix) {
            let growth = previous === 0 ? (current > 0 ? Infinity : 0) : ((current - previous) / previous) * 100;
            let icon = '‚Äî', colorClass = 'growth-neutral', text = '0.0%';
            if (growth === Infinity) { icon = '‚ñ≤'; colorClass = 'growth-positive'; text = '‚àû%'; }
            else if (growth > 0) { icon = '‚ñ≤'; colorClass = 'growth-positive'; text = `${growth.toFixed(1)}%`; }
            else if (growth < 0) { icon = '‚ñº'; colorClass = 'growth-negative'; text = `${Math.abs(growth).toFixed(1)}%`; }
            safeSetHTML(elementId, `<span class="${colorClass}">${icon} ${text} ${suffix}</span>`);
        }

        function calculateGrowthMetrics(data) {
            const daily = {};
            data.forEach(s => {
                if(!daily[s.date]) daily[s.date] = { orders: 0, revenue: 0, profit: 0 };
                daily[s.date].orders++; daily[s.date].revenue += s.totalAmount; daily[s.date].profit += s.profit;
            });
            const sorted = Object.keys(daily).sort();
            if(sorted.length < 2) { 
                ['growthOrders','growthRevenue','growthProfit'].forEach(id => safeSetHTML(id, '‚Äî')); 
                return; 
            }
            const today = daily[sorted[sorted.length-1]], yesterday = daily[sorted[sorted.length-2]];
            updateGrowthUI('growthOrders', today.orders, yesterday.orders, '');
            updateGrowthUI('growthRevenue', today.revenue, yesterday.revenue, '‚Çπ');
            updateGrowthUI('growthProfit', today.profit, yesterday.profit, '‚Çπ');
            calculateWeeklyGrowth(daily);
        }
        
        function calculateWeeklyGrowth(dailyData) {
            const dates = Object.keys(dailyData).sort();
            if (dates.length < 7) return; 

            const lastTwoWeeks = dates.slice(-14);
            const thisWeek = lastTwoWeeks.slice(-7);
            const lastWeek = lastTwoWeeks.slice(0, lastTwoWeeks.length - 7);

            const sumMetrics = (days) => days.reduce((acc, date) => {
                const day = dailyData[date] || { orders: 0, revenue: 0, profit: 0 };
                acc.orders += day.orders; 
                acc.revenue += day.revenue; 
                acc.profit += day.profit;
                return acc;
            }, { orders: 0, revenue: 0, profit: 0 });

            const current = sumMetrics(thisWeek);
            const previous = sumMetrics(lastWeek);

            const currentAOV = current.orders > 0 ? current.revenue / current.orders : 0;
            const previousAOV = previous.orders > 0 ? previous.revenue / previous.orders : 0;
            const currentAvgRev = current.revenue / thisWeek.length;
            const previousAvgRev = previous.revenue / lastWeek.length;

            updateGrowthUI('weeklyRevenueGrowth', current.revenue, previous.revenue, '‚Çπ');
            updateGrowthUI('weeklyOrderGrowth', current.orders, previous.orders, '');
            updateGrowthUI('weeklyAovGrowth', currentAOV, previousAOV, '‚Çπ');
            updateGrowthUI('weeklyAvgRevGrowth', currentAvgRev, previousAvgRev, '‚Çπ');

            const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            const periodText = `${formatDate(thisWeek[0])}-${formatDate(thisWeek[thisWeek.length-1])} vs Prev 7d`;
            
            ['weeklyRevenuePeriod', 'weeklyOrderPeriod', 'weeklyAovPeriod', 'weeklyAvgRevPeriod'].forEach(id => {
                safeSetText(id, periodText);
            });
        }

        function clearFilters() { 
            const startEl = document.getElementById('filterStartDate');
            const endEl = document.getElementById('filterEndDate');
            const restroEl = document.getElementById('filterRestro');
            if(startEl) startEl.value = ''; 
            if(endEl) endEl.value = ''; 
            if(restroEl) restroEl.value = ''; 
            updateDashboard(); 
        }

        function generateInvoice() {
            const restroName = document.getElementById('invoiceRestro').value;
            const startDate = document.getElementById('invoiceStart').value;
            const endDate = document.getElementById('invoiceEnd').value;

            if (!restroName || !startDate || !endDate) { alert("Select filters first."); return; }
            const invoiceData = allSalesData.filter(item => item.restro === restroName && item.date >= startDate && item.date <= endDate);
            if (invoiceData.length === 0) { alert("No records."); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const primaryColor = [255, 87, 34];
            const secondaryColor = [44, 62, 80];

            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setFillColor(...primaryColor);
            doc.roundedRect(15, 10, 15, 15, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text("KN", 18, 20);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Khanago", 35, 22);
            doc.setFontSize(16);
            doc.text("PAYOUT STATEMENT", 195, 22, { align: "right" });

            doc.setFillColor(245, 245, 245);
            doc.rect(0, 40, 210, 25, 'F');
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("RESTAURANT", 15, 50);
            doc.text("PAYOUT PERIOD", 15, 58);
            doc.setFont("helvetica", "normal");
            doc.text(":  " + restroName.toUpperCase(), 50, 50);
            doc.text(":  " + startDate + "  to  " + endDate, 50, 58);

            let totalItemPrice = 0, totalPlatFees = 0, totalTransFees = 0, totalComm = 0, totalPayout = 0;
            const tableRows = invoiceData.map(row => {
                const transFeeAmt = (row.itemPrice * row.transactionFees) / 100;
                const commissionAmt = (row.itemPrice * (row.commission || 0)) / 100;
                const payout = row.itemPrice - row.restroPlatformFees - transFeeAmt - commissionAmt;
                totalItemPrice += row.itemPrice; totalPlatFees += row.restroPlatformFees;
                totalTransFees += transFeeAmt; totalComm += commissionAmt; totalPayout += payout;
                return [row.date, row.itemPrice.toFixed(2), row.restroPlatformFees.toFixed(2), transFeeAmt.toFixed(2), commissionAmt.toFixed(2), payout.toFixed(2)];
            });

            doc.autoTable({
                startY: 75,
                head: [['Date', 'Item Price', 'Plat Fee', 'Trans Fee', 'Comm.', 'Net Payout']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: primaryColor, halign: 'center', fontSize: 10 },
                columnStyles: { 0: { cellWidth: 30 }, 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' }, 4: { halign: 'right' }, 5: { halign: 'right', fontStyle: 'bold' } },
                styles: { fontSize: 9 }
            });

            let finalY = doc.lastAutoTable.finalY + 15;
            if (finalY > 240) { doc.addPage(); finalY = 20; }
            doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text("FINANCIAL SUMMARY", 120, finalY);
            doc.autoTable({
                startY: finalY + 5,
                margin: { left: 120 },
                body: [
                    ['Total Item Sales', "Rs " + totalItemPrice.toFixed(2)],
                    ['Total Platform Fees', "(-) Rs " + totalPlatFees.toFixed(2)],
                    ['Total Transaction Fees', "(-) Rs " + totalTransFees.toFixed(2)],
                    ['Total Commissions', "(-) Rs " + totalComm.toFixed(2)],
                    [{ content: 'NET PAYABLE AMOUNT', styles: { fontStyle: 'bold', fillColor: [255, 240, 235] } }, { content: "Rs " + totalPayout.toFixed(2), styles: { fontStyle: 'bold', textColor: primaryColor, fillColor: [255, 240, 235] } }]
                ],
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 2 },
                columnStyles: { 0: { cellWidth: 50 }, 1: { halign: 'right' } }
            });

            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8); doc.setTextColor(150, 150, 150);
            doc.text("Disclaimer: System-generated statement. Khanago Sales Tracker Pro.", 15, pageHeight - 15);
            doc.text("Generated on: " + new Date().toLocaleString(), 15, pageHeight - 10);
            doc.save(`Payout_${restroName.replace(/\s+/g, '_')}.pdf`);
        }

        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('riderDate').valueAsDate = new Date();
        loadData();
    </script>
</body>
</html>
