<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Sales Tracker (Live)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); min-height: 100vh; padding: 20px; color: #333; }
        
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        
        header { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; padding: 25px; text-align: center; }
        header h1 { font-size: 2.2em; margin-bottom: 5px; }
        header p { opacity: 0.9; font-size: 0.9em; }

        .content { padding: 30px; }

        /* Sections */
        .card { background: #fff5f2; border: 2px solid #ff8c42; border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        h2 { color: #ff5722; margin-bottom: 20px; font-size: 1.6em; display: flex; align-items: center; gap: 10px; }
        h3 { color: #bf360c; margin-bottom: 15px; font-size: 1.1em; }

        /* Inputs & Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { color: #d84315; font-weight: 600; margin-bottom: 5px; font-size: 0.85em; text-transform: uppercase; }
        input, select { padding: 10px; border: 2px solid #ffccbc; border-radius: 8px; font-size: 0.95em; transition: 0.3s; background: white; }
        input:focus, select:focus { outline: none; border-color: #ff5722; box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1); }
        
        .readonly-field { background: #ffe0d6; font-weight: bold; color: #d84315; cursor: default; }

        /* Buttons */
        .btn { background: linear-gradient(135deg, #ff5722 0%, #ff6f00 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 87, 34, 0.3); }
        .btn-secondary { background: white; color: #ff5722; border: 2px solid #ff5722; }
        .btn-clear { background: #9e9e9e; background: linear-gradient(135deg, #757575 0%, #616161 100%); }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border: 1px solid #ffccbc; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 0.8em; color: #757575; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card p { color: #ff5722; font-size: 1.4em; font-weight: 800; margin: 0; }

        /* Filter Section */
        .filter-section { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #ffccbc; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9em; }
        thead { background: #ff5722; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        tbody tr:hover { background: #fff5f2; }
        .delete-btn { background: #ffebee; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .delete-btn:hover { background: #ef5350; color: white; }

        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ffccbc; height: 320px; }

        /* Loader */
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ffccbc; border-top-color: #ff5722; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <h3 style="color: #ff5722;">Syncing Data...</h3>
    </div>

    <div class="container">
        <header>
            <h1>üçΩÔ∏è Restaurant Sales Tracker</h1>
            <p>Live Dashboard ‚Ä¢ Connected to Google Sheets</p>
        </header>

        <div class="content">
            
            <div class="card">
                <h2>‚ûï New Entry</h2>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Restaurant</label>
                            <select id="restro" required>
                                <option value="">Select Restaurant</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Total Amount (‚Çπ)</label>
                            <input type="number" id="totalAmount" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Item Price (‚Çπ)</label>
                            <input type="number" id="itemPrice" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Trans. Fees (%)</label>
                            <input type="number" id="transactionFees" step="0.01" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Cust. Platform Fees</label>
                            <input type="number" id="customerPlatformFees" step="0.01" value="0" required>
                        </div>
                        <div class="form-group">
                            <label>Restro Platform Fees</label>
                            <input type="number" id="restroPlatformFees" step="0.01" value="2" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>Profit (Auto)</label>
                            <input type="number" id="profit" step="0.01" class="readonly-field" readonly>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">üîÑ Refresh</button>
                </form>
            </div>

            <div class="card">
                <h2>üõµ Daily Riders</h2>
                <form id="riderSetupForm" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="riderDate" required>
                    </div>
                    <div class="form-group">
                        <label>Count</label>
                        <input type="number" id="numRiders" min="1" placeholder="0" style="width: 80px;" required>
                    </div>
                    <button type="submit" class="btn">Set Riders</button>
                </form>
                <div id="riderInputsContainer"></div>
                <div id="riderHistoryContainer" style="margin-top: 15px; font-size: 0.9em; color: #555;"></div>
            </div>

            <div class="card">
                <h2>üìä Analytics & Filters</h2>
                
                <div class="filter-section">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group">
                            <label>Filter by Date</label>
                            <input type="date" id="filterDate">
                        </div>
                        <div class="form-group">
                            <label>Filter by Restaurant</label>
                            <select id="filterRestro">
                                <option value="">All Restaurants</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                            </select>
                        </div>
                        <div class="form-group" style="justify-content: flex-end; flex-direction: row; gap: 10px;">
                            <button class="btn" onclick="updateDashboard()">Apply Filters</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card"><h3>Orders</h3><p id="totalEntries">0</p></div>
                    <div class="stat-card"><h3>Revenue</h3><p id="totalSales">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Gross Profit</h3><p id="totalGrossProfit">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Rider Cost</h3><p id="totalRiderCost" style="color: #c62828;">‚Çπ0</p></div>
                    <div class="stat-card"><h3>Net Profit</h3><p id="netProfit" style="color: #2e7d32;">‚Çπ0</p></div>
                </div>

                <div class="charts-grid">
                    <div class="chart-box"><canvas id="restroChart"></canvas></div>
                    <div class="chart-box"><canvas id="trendChart"></canvas></div>
                </div>

                <h3 style="margin-top: 40px;">Detailed Records</h3>
                <div class="table-container">
                    <div id="tableContainer" style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // ‚úÖ YOUR GOOGLE APPS SCRIPT URL IS SET BELOW
        // ============================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwnIWaxlQnDN6J0NAVvuwvC48rhgwc42pikCjDx-0dzy2GetuGnYNmXQLwJkxLMat8l/exec';
        // ============================================================

        let allSalesData = [];
        let allRiderData = {}; 
        let restroChartInstance = null;
        let trendChartInstance = null;

        // --- CORE FUNCTIONS ---
        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        async function loadData() {
            showLoader();
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                
                allSalesData = data.sales;
                allRiderData = data.riders;
                
                updateDashboard(); // Updates everything (Stats, Table, Charts)
                renderRiderHistoryUI();
            } catch (e) {
                console.error(e);
                alert("Connection Error. Check console.");
            }
            hideLoader();
        }

        async function sendToSheet(payload) {
            showLoader();
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                setTimeout(() => { alert("Saved!"); loadData(); }, 1500);
            } catch (e) {
                console.error(e);
                alert("Save Failed.");
                hideLoader();
            }
        }

        // --- DASHBOARD LOGIC (With Filtering) ---
        function updateDashboard() {
            const filterDate = document.getElementById('filterDate').value;
            const filterRestro = document.getElementById('filterRestro').value;

            // 1. Filter Sales Data
            let filteredSales = allSalesData.filter(item => {
                const dateMatch = filterDate ? item.date === filterDate : true;
                const restroMatch = filterRestro ? item.restro === filterRestro : true;
                return dateMatch && restroMatch;
            });

            // 2. Calculate Rider Costs based on Filter context
            let relevantRiderCost = 0;
            
            if (filterDate) {
                // Exact date match
                if(allRiderData[filterDate]) {
                    relevantRiderCost = allRiderData[filterDate].reduce((sum, r) => sum + r.wage, 0);
                }
            } else {
                // Sum ALL rider costs if no specific date selected
                Object.values(allRiderData).forEach(dayList => {
                    dayList.forEach(r => relevantRiderCost += r.wage);
                });
            }

            // 3. Calculate Stats
            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalGross = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const netProfit = totalGross - relevantRiderCost;

            // 4. Update UI
            document.getElementById('totalEntries').textContent = filteredSales.length;
            document.getElementById('totalSales').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            document.getElementById('totalGrossProfit').textContent = `‚Çπ${totalGross.toLocaleString()}`;
            document.getElementById('totalRiderCost').textContent = `‚Çπ${relevantRiderCost.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `‚Çπ${netProfit.toLocaleString()}`;

            renderTable(filteredSales);
            renderCharts(filteredSales);
        }

        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterRestro').value = '';
            updateDashboard();
        }

        function renderTable(data) {
            // Sort by Date Descending
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let html = `<table><thead><tr><th>Date</th><th>Restaurant</th><th>Total</th><th>Profit</th><th>Action</th></tr></thead><tbody>`;
            
            if(sorted.length === 0) html += '<tr><td colspan="5" style="text-align:center; padding:20px;">No records found</td></tr>';
            
            sorted.slice(0, 100).forEach(row => {
                html += `<tr>
                    <td>${row.date}</td>
                    <td>${row.restro}</td>
                    <td>‚Çπ${row.totalAmount}</td>
                    <td style="color:#ff5722; font-weight:bold;">‚Çπ${row.profit.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteSale('${row.id}')">Del</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        function renderCharts(data) {
            const ctxRestro = document.getElementById('restroChart').getContext('2d');
            const ctxTrend = document.getElementById('trendChart').getContext('2d');

            // Process Data for Charts
            const restroAgg = {};
            const dateAgg = {};

            data.forEach(item => {
                restroAgg[item.restro] = (restroAgg[item.restro] || 0) + item.profit;
                dateAgg[item.date] = (dateAgg[item.date] || 0) + item.profit;
            });

            // Top Restros
            const sortedRestros = Object.entries(restroAgg).sort((a,b) => b[1] - a[1]).slice(0, 8);
            
            // Date Trend (Sorted)
            const sortedDates = Object.keys(dateAgg).sort();

            if(restroChartInstance) restroChartInstance.destroy();
            restroChartInstance = new Chart(ctxRestro, {
                type: 'bar',
                data: {
                    labels: sortedRestros.map(x => x[0]),
                    datasets: [{ label: 'Profit (‚Çπ)', data: sortedRestros.map(x => x[1]), backgroundColor: '#ff8c42', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Top Restaurants by Profit'} } }
            });

            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{ label: 'Daily Profit (‚Çπ)', data: sortedDates.map(d => dateAgg[d]), borderColor: '#ff5722', backgroundColor: 'rgba(255,87,34,0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text:'Profit Trend'} } }
            });
        }

        // --- FORM & RIDER HELPERS ---
        function calcProfit() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const rate = parseFloat(document.getElementById('transactionFees').value) || 0;
            const restroFee = parseFloat(document.getElementById('restroPlatformFees').value) || 0;
            const profit = (total - price) + restroFee + ((price * rate) / 100);
            document.getElementById('profit').value = profit.toFixed(2);
        }
        ['totalAmount','itemPrice','transactionFees'].forEach(id => document.getElementById(id).addEventListener('input', calcProfit));

        document.getElementById('salesForm').addEventListener('submit', e => {
            e.preventDefault();
            const entry = {
                id: Date.now(), date: document.getElementById('date').value,
                restro: document.getElementById('restro').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                itemPrice: parseFloat(document.getElementById('itemPrice').value),
                transactionFees: parseFloat(document.getElementById('transactionFees').value),
                customerPlatformFees: parseFloat(document.getElementById('customerPlatformFees').value),
                restroPlatformFees: parseFloat(document.getElementById('restroPlatformFees').value),
                profit: parseFloat(document.getElementById('profit').value)
            };
            sendToSheet({ action: 'addSale', entry: entry });
            const d = document.getElementById('date').value;
            e.target.reset();
            document.getElementById('date').value = d;
            document.getElementById('transactionFees').value = 1; 
            document.getElementById('restroPlatformFees').value = 2;
        });

        document.getElementById('riderSetupForm').addEventListener('submit', e => {
            e.preventDefault();
            const date = document.getElementById('riderDate').value;
            const count = document.getElementById('numRiders').value;
            let html = `<div style="margin:15px 0; background:white; padding:10px; border:1px solid #ddd;"><h4>Enter ${count} Riders for ${date}</h4>`;
            for(let i=0; i<count; i++) {
                html += `<div style="display:flex; gap:10px; margin-bottom:5px;">
                    <input type="text" placeholder="Name" class="r-name" style="flex:2">
                    <input type="number" placeholder="Wage" class="r-wage" style="flex:1">
                </div>`;
            }
            html += `<button class="btn" onclick="saveRiders('${date}')">Save</button> <button class="btn btn-clear" onclick="this.parentNode.remove()">Cancel</button></div>`;
            document.getElementById('riderInputsContainer').innerHTML = html;
        });

        function saveRiders(date) {
            const names = document.querySelectorAll('.r-name');
            const wages = document.querySelectorAll('.r-wage');
            let riders = [];
            names.forEach((n,i) => { if(n.value && wages[i].value) riders.push({name:n.value, wage:parseFloat(wages[i].value)}) });
            if(riders.length) {
                sendToSheet({ action:'saveRiders', date:date, riders:riders });
                document.getElementById('riderInputsContainer').innerHTML = '';
            }
        }

        function renderRiderHistoryUI() {
            const container = document.getElementById('riderHistoryContainer');
            if(Object.keys(allRiderData).length === 0) { container.innerHTML = ''; return; }
            let html = '<strong>History:</strong> ';
            const dates = Object.keys(allRiderData).sort().reverse().slice(0, 5);
            dates.forEach(d => {
                const total = allRiderData[d].reduce((s,r) => s+r.wage, 0);
                html += `<span style="background:white; border:1px solid #ccc; padding:2px 8px; margin-right:5px; border-radius:4px;">${d}: ‚Çπ${total} <span style="cursor:pointer; color:red;" onclick="deleteRiders('${d}')">x</span></span>`;
            });
            container.innerHTML = html;
        }

        function deleteSale(id) { if(confirm("Delete?")) sendToSheet({action:'deleteSale', id:id}); }
        function deleteRiders(date) { if(confirm("Delete riders for "+date+"?")) sendToSheet({action:'deleteRiders', date:date}); }

        // Init
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('riderDate').valueAsDate = new Date();
        loadData();
    </script>
</body>
</html>
