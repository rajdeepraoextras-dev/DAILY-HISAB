<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khanago Sales Tracker (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; text-transform: uppercase; }
        
        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 50%, #ffa45c 100%);
            min-height: 100vh; 
            padding: 20px; 
            color: #1a202c;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 24px; 
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        header { 
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white; 
            padding: 35px 40px; 
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        header h1 { 
            font-size: 2.8em; 
            margin-bottom: 8px; 
            font-weight: 800;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        header p { 
            opacity: 0.95; 
            font-size: 1em; 
            font-weight: 500;
            letter-spacing: 0.5px;
            position: relative;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .header-logo {
            width: 70px;
            height: 70px;
            border-radius: 14px;
            object-fit: contain;
            background: white;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .content { padding: 40px; background: #f7fafc; }
        
        .card { 
            background: white;
            border: none;
            border-radius: 16px; 
            padding: 30px; 
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02), 0 1px 3px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #ff6b35 0%, #ff8c42 100%);
        }
        
        .card:hover { 
            box-shadow: 0 12px 24px rgba(255, 107, 53, 0.12), 0 4px 8px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        h2 { 
            color: #2d3748; 
            margin-bottom: 24px; 
            font-size: 1.5em; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 24px; 
        }
        
        .form-group { display: flex; flex-direction: column; }
        
        label { 
            color: #4a5568; 
            font-weight: 600; 
            margin-bottom: 8px; 
            font-size: 0.8em; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        input, select { 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-size: 0.95em; 
            transition: all 0.3s ease; 
            background: white;
            font-family: 'Poppins', sans-serif;
            text-transform: none;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: #ff6b35; 
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
            transform: translateY(-1px);
        }
        
        .readonly-field { 
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            font-weight: 700; 
            color: #6b46c1; 
            cursor: not-allowed;
            border-color: #e9d8fd;
        }
        
        .calc-hint { 
            font-size: 0.75em; 
            color: #718096; 
            margin-top: 6px; 
            font-weight: 600;
        }
        
        .btn { 
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white; 
            border: none; 
            padding: 14px 28px; 
            border-radius: 10px; 
            font-size: 1em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            letter-spacing: 0.3px;
        }
        
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }
        
        .btn:active { transform: translateY(-1px); }
        
        .btn-secondary { 
            background: white; 
            color: #ff6b35; 
            border: 2px solid #ff6b35;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.15);
        }
        
        .btn-secondary:hover { 
            background: #fff5f0;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
        }
        
        .btn-clear { 
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
        }
        
        .btn-invoice { 
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
            box-shadow: 0 4px 15px rgba(56, 178, 172, 0.3);
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            border: 1px solid #e2e8f0; 
            border-radius: 14px; 
            padding: 20px; 
            text-align: center; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #ff6b35 0%, #ff8c42 100%);
        }
        
        .stat-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.15);
        }
        
        .stat-card h3 { 
            font-size: 0.75em; 
            color: #718096; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.8px;
            font-weight: 700;
        }
        
        .stat-card p { 
            color: #ff6b35; 
            font-size: 1.6em; 
            font-weight: 800; 
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        .growth-positive { color: #38a169; font-size: 0.85em; font-weight: 700; }
        .growth-negative { color: #e53e3e; font-size: 0.85em; font-weight: 700; }
        .growth-neutral { color: #718096; font-size: 0.85em; font-weight: 700; }
        
        .filter-section { 
            background: linear-gradient(135deg, #fff5f0 0%, #f7fafc 100%);
            padding: 24px; 
            border-radius: 14px; 
            border: 1px solid #ffe5d9; 
            margin-bottom: 30px; 
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.06);
        }
        
        .table-container { 
            overflow-x: auto; 
            border-radius: 14px; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            font-size: 0.9em; 
        }
        
        thead { 
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white; 
        }
        
        th { 
            padding: 16px 18px; 
            text-align: left; 
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }
        
        td { 
            padding: 14px 18px; 
            border-bottom: 1px solid #f1f5f9; 
            white-space: nowrap;
        }
        
        tbody tr { transition: all 0.2s ease; }
        tbody tr:hover { background: #f8f9ff; transform: scale(1.01); }
        
        .delete-btn { 
            background: #fff5f5; 
            color: #e53e3e; 
            border: 1px solid #feb2b2; 
            padding: 6px 14px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.8em;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover { 
            background: #e53e3e; 
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }
        
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            z-index: 9999; 
        }
        
        .spinner { 
            width: 60px; 
            height: 60px; 
            border: 5px solid #e2e8f0; 
            border-top: 5px solid #ff6b35; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        h3 { 
            color: #2d3748; 
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 50px 45px;
            width: 400px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b35 0%, #ff8c42 50%, #ffa45c 100%);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px auto;
            overflow: hidden;
        }
        
        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .login-box h2 {
            text-align: center;
            color: #1a202c;
            margin-bottom: 30px;
            font-size: 1.75em;
            font-weight: 700;
            letter-spacing: -0.5px;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            width: 100%;
            display: block;
        }
        
        .login-box .login-subtitle {
            text-align: center;
            color: #a0aec0;
            margin-bottom: 30px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            font-weight: 500;
            width: 100%;
            display: block;
        }
        
        .login-input-group {
            position: relative;
            margin-bottom: 20px;
        }
        
        .login-input-group label {
            display: block;
            font-size: 0.8em;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            background: #f7fafc;
            text-transform: none;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #ff6b35;
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }
        
        .login-input::placeholder {
            color: #a0aec0;
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.35);
            margin-top: 10px;
            letter-spacing: 0.3px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.45);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .login-error {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            color: #c53030;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            display: none;
            border: 1px solid #feb2b2;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #a0aec0;
            font-size: 0.8em;
        }
        
        .app-content {
            display: none;
        }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://i.ibb.co/qFhgyxtS/Untitled-design-4.png" alt="Khanago Logo">
            </div>
            <h2>Welcome Back</h2>
            <div id="loginError" class="login-error">Invalid credentials!</div>
            <form id="loginForm">
                <div class="login-input-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" class="login-input" required autocomplete="username">
                </div>
                <div class="login-input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="login-input" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            <div class="login-footer">Khanago Sales Tracker Pro</div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="color: #ff6b35; font-weight: 700;">Syncing Supabase...</h3>
    </div>

    <div class="container app-content">
        <header>
            <div class="header-content">
                <img src="https://i.ibb.co/qFhgyxtS/Untitled-design-4.png" alt="Khanago Logo" class="header-logo">
                <div>
                    <h1>Khanago Sales Tracker</h1>
                    <p>Live Dashboard â€¢ Connected to Supabase</p>
                </div>
            </div>
        </header>

        <div class="content">
            <!-- Close Business Day Section -->
            <div class="card" style="background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #ff6b35; padding: 12px; border-radius: 12px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M9 16l2 2 4-4"/></svg>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: white;">Close Business Day</h3>
                            <p style="margin: 4px 0 0 0; color: #a0aec0; font-size: 0.85em;">Send all rider reports & close the day</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <input type="date" id="closingDate" style="padding: 12px 16px; border-radius: 10px; border: none; font-size: 1em; background: white; color: #1a202c;">
                        <button class="btn" onclick="closeBusinessDay()">Close Date</button>
                    </div>
                </div>
                <div id="closingStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
            </div>

            <div class="card">
                <h2>âž• New Entry</h2>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                        <div class="form-group">
                            <label>Restaurant</label>
                            <select id="restro" required>
                                <option value="">Select Restaurant</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                                <option value="Shifa Biryani">Shifa Biryani</option>
                                <option value="Star Biryani">Star Biryani</option>
                                <option value="IB Cafe">IB Cafe</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rider Name</label>
                            <select id="riderNameSales" required>
                                <option value="">Select Rider</option>
                                <option value="Brijesh Gupta">Brijesh Gupta</option>
                                <option value="Sumit Kumar">Sumit Kumar</option>
                                <option value="Sandeep Gond">Sandeep Gond</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Total Amount (â‚¹)</label><input type="number" id="totalAmount" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group"><label>Item Price (â‚¹)</label><input type="number" id="itemPrice" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group">
                            <label>Trans. Fees (%)</label>
                            <input type="number" id="transactionFees" step="0.01" value="1" required>
                            <span id="transFeeCalc" class="calc-hint">1% = â‚¹0.00</span>
                        </div>
                        <div class="form-group">
                            <label>Commission (%)</label>
                            <input type="number" id="commission" step="0.01" value="0" required>
                            <span id="commissionCalc" class="calc-hint">0% = â‚¹0.00</span>
                        </div>
                        <div class="form-group"><label>Cust. Platform Fees</label><input type="number" id="customerPlatformFees" step="0.01" value="0" required></div>
                        <div class="form-group"><label>Restro Platform Fees</label><input type="number" id="restroPlatformFees" step="0.01" value="2" class="readonly-field" readonly></div>
                        <div class="form-group"><label>Profit (Auto)</label><input type="number" id="profit" step="0.01" class="readonly-field" readonly></div>
                    </div>
                    <button type="submit" class="btn">Add Sale</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">ðŸ”„ Refresh</button>
                </form>
            </div>

            <div class="card" style="border-color: #2c3e50; background-color: #f8f9fa;">
                <h2 style="color: #2c3e50;">ðŸ§¾ Invoice PDF Generator</h2>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label>Select Restaurant</label>
                        <select id="invoiceRestro">
                            <option value="">Select Restaurant</option>
                            <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                            <option value="7 Star">7 Star</option>
                            <option value="Ethens">Ethens</option>
                            <option value="Royal Cafe">Royal Cafe</option>
                            <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                            <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                            <option value="Rajshahi">Rajshahi</option>
                            <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                            <option value="Raju Handi Meat">Raju Handi Meat</option>
                            <option value="Shifa Biryani">Shifa Biryani</option>
                            <option value="Star Biryani">Star Biryani</option>
                            <option value="IB Cafe">IB Cafe</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Start Date</label><input type="date" id="invoiceStart"></div>
                    <div class="form-group"><label>End Date</label><input type="date" id="invoiceEnd"></div>
                    <div class="form-group" style="justify-content: flex-end;"><button class="btn btn-invoice" onclick="generateInvoice()">Download Receipt</button></div>
                </div>
            </div>

            <div class="card">
                <h2>ðŸ›µ Rider Cash Statement</h2>
                <div class="form-grid" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Select Rider</label>
                        <select id="invoiceRider" onchange="autoFillRiderPhone()">
                            <option value="">Select Rider</option>
                            <option value="Brijesh Gupta">Brijesh Gupta</option>
                            <option value="Sumit Kumar">Sumit Kumar</option>
                            <option value="Sandeep Gond">Sandeep Gond</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Number</label>
                        <input type="tel" id="riderWhatsApp" placeholder="91XXXXXXXXXX" style="width: 100%;">
                    </div>
                    <div class="form-group"><label>Start Date</label><input type="date" id="riderInvoiceStart"></div>
                    <div class="form-group"><label>End Date</label><input type="date" id="riderInvoiceEnd"></div>
                </div>
                <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #ff6b35;">
                    <h4 style="margin-bottom: 15px; color: #2d3748; font-weight: 600;">Adjustments</h4>
                    <div id="adjustmentsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addAdjustmentRow()" style="margin-top: 10px;">+ Add Adjustment</button>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; flex-wrap: wrap; margin-top: 10px;">
                    <button class="btn" onclick="generateRiderInvoice()">Download PDF</button>
                    <button class="btn" onclick="sendRiderReportWhatsApp()">Send via WhatsApp</button>
                </div>
                <div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2d3748; font-weight: 600;">PDF Download History</h4>
                    <div id="riderReportHistory" style="font-size: 0.9em; color: #555;">Loading...</div>
                </div>
            </div>

            <div class="card" style="border-color: #4a6baf; background-color: #f8f9ff;">
                <h2 style="color: #4a6baf;">ðŸ“ˆ Weekly Growth</h2>
                <div class="stats" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <h3>Revenue Growth</h3>
                        <div id="weeklyRevenueGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">â€”</div>
                        <p class="text-muted" id="weeklyRevenuePeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Order Growth</h3>
                        <div id="weeklyOrderGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">â€”</div>
                        <p class="text-muted" id="weeklyOrderPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>AOV Growth</h3>
                        <div id="weeklyAovGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">â€”</div>
                        <p class="text-muted" id="weeklyAovPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Rev/Day Growth</h3>
                        <div id="weeklyAvgRevGrowth" class="growth-neutral" style="font-size: 1.5em; margin: 10px 0;">â€”</div>
                        <p class="text-muted" id="weeklyAvgRevPeriod" style="font-size: 0.75em;">Calculating...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ðŸ“Š Analytics & Filters</h2>
                <div class="filter-section">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group"><label>From Date</label><input type="date" id="filterStartDate"></div>
                        <div class="form-group"><label>To Date</label><input type="date" id="filterEndDate"></div>
                        <div class="form-group">
                            <label>Filter by Restaurant</label>
                            <select id="filterRestro">
                                <option value="">All Restaurants</option>
                                <option value="Deep Handi Mutton">Deep Handi Mutton</option>
                                <option value="7 Star">7 Star</option>
                                <option value="Ethens">Ethens</option>
                                <option value="Royal Cafe">Royal Cafe</option>
                                <option value="Verma Ji Non Veg Restaurant">Verma Ji Non Veg Restaurant</option>
                                <option value="Maa Vaishno Sweets & Bakers">Maa Vaishno Sweets & Bakers</option>
                                <option value="Rajshahi">Rajshahi</option>
                                <option value="Shiva Muradabadi Chicken Biryani">Shiva Muradabadi Chicken Biryani</option>
                                <option value="Raju Handi Meat">Raju Handi Meat</option>
                                <option value="Shifa Biryani">Shifa Biryani</option>
                                <option value="Star Biryani">Star Biryani</option>
                                <option value="IB Cafe">IB Cafe</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="justify-content: flex-end; flex-direction: row; gap: 10px;">
                            <button class="btn" onclick="updateDashboard()">Apply Filters</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card"><h3>Total Orders</h3><p id="totalEntries">0</p></div>
                    <div class="stat-card"><h3>Total Revenue</h3><p id="totalSales">â‚¹0</p></div>
                    <div class="stat-card" style="border-color: #ff5722; background: #fffbf9;"><h3 style="color: #ff5722;">Proj. Month Revenue</h3><p id="projRevenue">â‚¹0</p></div>
                    <div class="stat-card"><h3>Gross Profit</h3><p id="totalGrossProfit">â‚¹0</p></div>
                    <div class="stat-card" style="border-color: #1565c0; background: #e3f2fd;"><h3 style="color: #1565c0;">Main Profit</h3><p id="mainProfit" style="color: #1565c0;">â‚¹0</p></div>
                    <div class="stat-card"><h3>Operational Cost</h3><p id="totalOperationalCost" style="color: #c62828;">â‚¹0</p></div>
                    <div class="stat-card"><h3>Net Profit</h3><p id="netProfit" style="color: #2e7d32;">â‚¹0</p></div>
                    <div class="stat-card"><h3>Net Margin</h3><p id="netMargin" style="color: #2e7d32;">0%</p></div>
                    <div class="stat-card"><h3>Avg Orders/Day</h3><p id="avgOrdersPerDay">0</p></div>
                    <div class="stat-card"><h3>Avg Revenue/Day</h3><p id="avgRevenuePerDay">â‚¹0</p></div>
                    <div class="stat-card"><h3>Avg Profit/Order</h3><p id="avgProfitPerOrder">â‚¹0</p></div>
                    <div class="stat-card"><h3>AOV (Order Val)</h3><p id="aov">â‚¹0</p></div>
                    <div class="stat-card"><h3>Daily Order Growth</h3><div id="growthOrders" class="growth-neutral">â€”</div></div>
                    <div class="stat-card"><h3>Daily Rev Growth</h3><div id="growthRevenue" class="growth-neutral">â€”</div></div>
                    <div class="stat-card"><h3>Daily Profit Growth</h3><div id="growthProfit" class="growth-neutral">â€”</div></div>
                </div>

                <h3 style="margin-top: 40px;">Detailed Records</h3>
                <div class="table-container">
                    <div id="tableContainer" style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aHJhaHVpb25zdnp5dXpkdGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzA4MTcsImV4cCI6MjA4MTY0NjgxN30.ypEmevr3XTuyNtJxUSSqCplAdcru9fkE3q15HOQHrVY';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allSalesData = [];
        let allRiderData = {};
        let allRiderReports = [];
        let operationalCostData = [];
        
        // Default WhatsApp number for sending reports
        const defaultWhatsAppNumber = '917388322574';
        
        function autoFillRiderPhone() {
            // Always use the default number
            document.getElementById('riderWhatsApp').value = defaultWhatsAppNumber;
        }
        
        let isAuthenticated = false;

        // Check session on page load
        function checkSession() {
            const session = sessionStorage.getItem('sales_authenticated');
            if (session === 'true') {
                isAuthenticated = true;
                showApp();
                loadData();
            }
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            showLoader();
            
            try {
                const { data, error } = await _supabase
                    .from('credentials')
                    .select('*')
                    .eq('name', 'sales')
                    .single();
                
                console.log('Database response:', data);
                console.log('Entered username:', username);
                console.log('Entered password:', password);
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                if (data && data.username === username && data.password === password) {
                    isAuthenticated = true;
                    sessionStorage.setItem('sales_authenticated', 'true');
                    showApp();
                    loadData();
                } else {
                    console.log('Credentials do not match');
                    console.log('Expected username:', data?.username);
                    console.log('Expected password:', data?.password);
                    errorDiv.textContent = 'Invalid username or password!';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Authentication error:', error);
                errorDiv.textContent = 'Authentication error: ' + error.message;
                errorDiv.style.display = 'block';
            }
            
            hideLoader();
        }

        function showApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.app-content').style.display = 'block';
        }

        // Attach login form handler
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            checkSession();
        });

        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        const safeSetHTML = (id, html) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = html;
        };

        const safeSetText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.textContent = text;
        };

        async function loadData() {
            showLoader();
            try {
                const { data: sales, error: sErr } = await _supabase.from('sales').select('*');
                if (sErr) throw sErr;
                
                allSalesData = sales.map(s => ({
                    id: s.id,
                    date: s.Date,
                    restro: s.Restaurant,
                    riderName: s["Rider Name"] || '',
                    totalAmount: s["Total Amount"],
                    itemPrice: s["Item Price"],
                    deliveryCharge: s["Delivery Charge"] || 0,
                    transactionFees: s["Transaction Fees %"],
                    commission: s["Commission %"],
                    customerPlatformFees: s["Customer Platform Fees"],
                    restroPlatformFees: s["Restro Platform Fees"],
                    profit: s.Profit
                }));

                // Load operational cost data from EXEC MANAGER LEVEL & RIDER EXPENSE view
                const { data: operationalData, error: opErr } = await _supabase.from('EXEC MANAGER LEVEL & RIDER EXPENSE').select('*');
                if (opErr) console.error('Operational cost error:', opErr);
                
                operationalCostData = operationalData || [];

                // Load rider reports history
                const { data: reports, error: repErr } = await _supabase.from('rider_reports').select('*').order('downloaded_at', { ascending: false });
                if (!repErr && reports) {
                    allRiderReports = reports;
                    renderRiderReportHistory();
                }

                updateDashboard();
            } catch (e) {
                console.error(e);
                alert("Supabase Error: " + e.message);
            }
            hideLoader();
        }

        async function addSaleEntry(entry) {
            showLoader();
            const { error } = await _supabase.from('sales').insert([{
                "Date": entry.date,
                "Restaurant": entry.restro,
                "Rider Name": entry.riderName,
                "Total Amount": entry.totalAmount,
                "Item Price": entry.itemPrice,
                "Transaction Fees %": entry.transactionFees,
                "Transaction Fees Amount": (entry.itemPrice * entry.transactionFees) / 100,
                "Customer Platform Fees": entry.customerPlatformFees,
                "Restro Platform Fees": entry.restroPlatformFees,
                "Profit": entry.profit,
                "Commission %": entry.commission,
                "Commission Amt": (entry.itemPrice * entry.commission) / 100
            }]);
            
            if (error) alert(error.message);
            else { alert("Sale Saved!"); loadData(); }
            hideLoader();
        }

        async function saveRiders(date, riders) {
            showLoader();
            const rows = riders.map(r => ({
                "Date": date,
                "Rider Name": r.name,
                "WAGE": r.wage
            }));
            const { error } = await _supabase.from('riders').insert(rows);
            if (error) alert(error.message);
            else { alert("Riders Saved!"); loadData(); }
            hideLoader();
        }

        async function deleteSale(id) {
            if(!confirm("Delete this sale?")) return;
            showLoader();
            const { error } = await _supabase.from('sales').delete().eq('id', id);
            if (error) alert(error.message);
            else loadData();
            hideLoader();
        }

        function editSale(id) {
            const sale = allSalesData.find(s => s.id === id);
            if (!sale) return;
            
            const row = document.getElementById(`row-${id}`);
            if (!row) return;
            
            row.innerHTML = `
                <td><input type="date" id="edit-date-${id}" value="${sale.date}" style="width:130px; padding:5px;"></td>
                <td>
                    <select id="edit-restro-${id}" style="width:180px; padding:5px;">
                        <option value="Deep Handi Mutton" ${sale.restro === 'Deep Handi Mutton' ? 'selected' : ''}>Deep Handi Mutton</option>
                        <option value="7 Star" ${sale.restro === '7 Star' ? 'selected' : ''}>7 Star</option>
                        <option value="Ethens" ${sale.restro === 'Ethens' ? 'selected' : ''}>Ethens</option>
                        <option value="Royal Cafe" ${sale.restro === 'Royal Cafe' ? 'selected' : ''}>Royal Cafe</option>
                        <option value="Verma Ji Non Veg Restaurant" ${sale.restro === 'Verma Ji Non Veg Restaurant' ? 'selected' : ''}>Verma Ji Non Veg Restaurant</option>
                        <option value="Maa Vaishno Sweets & Bakers" ${sale.restro === 'Maa Vaishno Sweets & Bakers' ? 'selected' : ''}>Maa Vaishno Sweets & Bakers</option>
                        <option value="Rajshahi" ${sale.restro === 'Rajshahi' ? 'selected' : ''}>Rajshahi</option>
                        <option value="Shiva Muradabadi Chicken Biryani" ${sale.restro === 'Shiva Muradabadi Chicken Biryani' ? 'selected' : ''}>Shiva Muradabadi Chicken Biryani</option>
                        <option value="Raju Handi Meat" ${sale.restro === 'Raju Handi Meat' ? 'selected' : ''}>Raju Handi Meat</option>
                        <option value="Shifa Biryani" ${sale.restro === 'Shifa Biryani' ? 'selected' : ''}>Shifa Biryani</option>
                        <option value="Star Biryani" ${sale.restro === 'Star Biryani' ? 'selected' : ''}>Star Biryani</option>
                        <option value="IB Cafe" ${sale.restro === 'IB Cafe' ? 'selected' : ''}>IB Cafe</option>
                        <option value="Other" ${sale.restro === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                </td>
                <td><input type="number" id="edit-total-${id}" value="${sale.totalAmount}" step="0.01" style="width:80px; padding:5px;"></td>
                <td><input type="number" id="edit-item-${id}" value="${sale.itemPrice}" step="0.01" style="width:80px; padding:5px;"></td>
                <td><input type="number" id="edit-trans-${id}" value="${sale.transactionFees}" step="0.01" style="width:60px; padding:5px;"></td>
                <td><input type="number" id="edit-comm-${id}" value="${sale.commission}" step="0.01" style="width:60px; padding:5px;"></td>
                <td style="color:#ff5722; font-weight:bold;">â‚¹${sale.profit.toFixed(2)}</td>
                <td>
                    <button class="delete-btn" style="background:#c8e6c9; color:#2e7d32; margin-right:5px;" onclick="updateSale(${id})">Save</button>
                    <button class="delete-btn" style="background:#fff3e0; color:#e65100;" onclick="loadData()">Cancel</button>
                </td>
            `;
        }

        async function updateSale(id) {
            const date = document.getElementById(`edit-date-${id}`).value;
            const restro = document.getElementById(`edit-restro-${id}`).value;
            const totalAmount = parseFloat(document.getElementById(`edit-total-${id}`).value);
            const itemPrice = parseFloat(document.getElementById(`edit-item-${id}`).value);
            const transactionFees = parseFloat(document.getElementById(`edit-trans-${id}`).value);
            const commission = parseFloat(document.getElementById(`edit-comm-${id}`).value);
            
            const transFeeAmt = (itemPrice * transactionFees) / 100;
            const commissionAmt = (itemPrice * commission) / 100;
            const restroPlatformFees = 2;
            const profit = ((totalAmount - itemPrice) + restroPlatformFees + transFeeAmt + commissionAmt);
            
            showLoader();
            const { error } = await _supabase.from('sales').update({
                "Date": date,
                "Restaurant": restro,
                "Total Amount": totalAmount,
                "Item Price": itemPrice,
                "Transaction Fees %": transactionFees,
                "Transaction Fees Amount": transFeeAmt,
                "Commission %": commission,
                "Commission Amt": commissionAmt,
                "Restro Platform Fees": restroPlatformFees,
                "Profit": profit
            }).eq('id', id);
            
            if (error) alert(error.message);
            else { alert("Sale Updated!"); loadData(); }
            hideLoader();
        }

        async function deleteRiders(date) {
            if(!confirm("Delete all riders for " + date + "?")) return;
            showLoader();
            const { error } = await _supabase.from('riders').delete().eq('Date', date);
            if (error) alert(error.message);
            else loadData();
            hideLoader();
        }

        function updateDashboard() {
            const filterStart = document.getElementById('filterStartDate').value;
            const filterEnd = document.getElementById('filterEndDate').value;
            const filterRestro = document.getElementById('filterRestro').value;

            let filteredSales = allSalesData.filter(item => {
                const startMatch = filterStart ? item.date >= filterStart : true;
                const endMatch = filterEnd ? item.date <= filterEnd : true;
                const restroMatch = filterRestro ? item.restro === filterRestro : true;
                return startMatch && endMatch && restroMatch;
            });

            // Calculate operational cost from EXEC MANAGER LEVEL & RIDER EXPENSE view
            let operationalCost = 0;
            operationalCostData.forEach(item => {
                operationalCost += parseFloat(item.amount) || 0;
            });

            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalGross = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const mainProfit = filteredSales.reduce((sum, s) => sum + (s.totalAmount - s.itemPrice - (s.deliveryCharge || 0)), 0);
            const netProfit = totalGross - operationalCost;
            const entryCount = filteredSales.length;
            const uniqueDates = new Set(filteredSales.map(s => s.date)).size || 1;
            
            safeSetText('totalEntries', entryCount);
            safeSetText('totalSales', `â‚¹${totalRevenue.toLocaleString()}`);
            safeSetText('totalGrossProfit', `â‚¹${totalGross.toLocaleString()}`);
            safeSetText('mainProfit', `â‚¹${mainProfit.toLocaleString()}`);
            safeSetText('totalOperationalCost', `â‚¹${operationalCost.toLocaleString()}`);
            safeSetText('netProfit', `â‚¹${netProfit.toLocaleString()}`);
            safeSetText('avgOrdersPerDay', (entryCount / uniqueDates).toFixed(1));
            safeSetText('avgRevenuePerDay', `â‚¹${(totalRevenue / uniqueDates).toFixed(0)}`);
            safeSetText('netMargin', `${(totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0).toFixed(1)}%`);
            safeSetText('avgProfitPerOrder', `â‚¹${(entryCount > 0 ? netProfit / entryCount : 0).toFixed(1)}`);
            safeSetText('aov', `â‚¹${(entryCount > 0 ? totalRevenue / entryCount : 0).toFixed(0)}`);

            calculateGrowthMetrics(filteredSales);
            calculateMonthlyProjection(allSalesData);
            renderTable(filteredSales);
        }

        function calculateMonthlyProjection(data) {
            const now = new Date(), currentYear = now.getFullYear(), currentMonth = now.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const currSales = data.filter(s => {
                const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            const uniqueDays = new Set(currSales.map(s => s.date)).size;
            const rev = currSales.reduce((s, x) => s + x.totalAmount, 0);
            const projected = uniqueDays > 0 ? (rev / uniqueDays) * daysInMonth : 0;
            safeSetText('projRevenue', `â‚¹${projected.toLocaleString(undefined, {maximumFractionDigits: 0})}`);
        }

        function renderTable(data) {
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
            let html = `<table><thead><tr><th>Date</th><th>Restaurant</th><th>Total</th><th>Item Price</th><th>Trans Fee %</th><th>Comm %</th><th>Profit</th><th>Actions</th></tr></thead><tbody>`;
            if(sorted.length === 0) html += '<tr><td colspan="8" style="text-align:center; padding:20px;">No records found</td></tr>';
            sorted.slice(0, 100).forEach(row => {
                html += `<tr id="row-${row.id}">`;
                html += `<td>${row.date}</td>`;
                html += `<td>${row.restro}</td>`;
                html += `<td>â‚¹${row.totalAmount}</td>`;
                html += `<td>â‚¹${row.itemPrice}</td>`;
                html += `<td>${row.transactionFees}%</td>`;
                html += `<td>${row.commission}%</td>`;
                html += `<td style="color:#ff5722; font-weight:bold;">â‚¹${row.profit.toFixed(2)}</td>`;
                html += `<td><button class="delete-btn" style="background:#e3f2fd; color:#1565c0; margin-right:5px;" onclick="editSale(${row.id})">Edit</button><button class="delete-btn" onclick="deleteSale(${row.id})">Del</button></td>`;
                html += `</tr>`;
            });
            safeSetHTML('tableContainer', html + '</tbody></table>');
        }

        function calcProfit() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const rate = parseFloat(document.getElementById('transactionFees').value) || 0;
            const commission = parseFloat(document.getElementById('commission').value) || 0;
            const restroFee = parseFloat(document.getElementById('restroPlatformFees').value) || 0;
            const transFeeAmt = (price * rate) / 100, commissionAmt = (price * commission) / 100;
            safeSetText('transFeeCalc', `${rate}% = â‚¹${transFeeAmt.toFixed(2)}`);
            safeSetText('commissionCalc', `${commission}% = â‚¹${commissionAmt.toFixed(2)}`);
            document.getElementById('profit').value = ((total - price) + restroFee + transFeeAmt + commissionAmt).toFixed(2);
        }
        ['totalAmount','itemPrice','transactionFees','commission'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', calcProfit);
        });

        document.getElementById('salesForm').addEventListener('submit', e => {
            e.preventDefault();
            const entry = {
                date: document.getElementById('date').value,
                restro: document.getElementById('restro').value,
                riderName: document.getElementById('riderNameSales').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                itemPrice: parseFloat(document.getElementById('itemPrice').value),
                transactionFees: parseFloat(document.getElementById('transactionFees').value),
                commission: parseFloat(document.getElementById('commission').value),
                customerPlatformFees: parseFloat(document.getElementById('customerPlatformFees').value),
                restroPlatformFees: parseFloat(document.getElementById('restroPlatformFees').value),
                profit: parseFloat(document.getElementById('profit').value)
            };
            addSaleEntry(entry);
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('transactionFees').value = 1; 
            document.getElementById('commission').value = 0; 
            document.getElementById('restroPlatformFees').value = 2;
        });

        function updateGrowthUI(elementId, current, previous, suffix) {
            let growth = previous === 0 ? (current > 0 ? Infinity : 0) : ((current - previous) / previous) * 100;
            let icon = 'â€”', colorClass = 'growth-neutral', text = '0.0%';
            if (growth === Infinity) { icon = 'â–²'; colorClass = 'growth-positive'; text = 'âˆž%'; }
            else if (growth > 0) { icon = 'â–²'; colorClass = 'growth-positive'; text = `${growth.toFixed(1)}%`; }
            else if (growth < 0) { icon = 'â–¼'; colorClass = 'growth-negative'; text = `${Math.abs(growth).toFixed(1)}%`; }
            safeSetHTML(elementId, `<span class="${colorClass}">${icon} ${text} ${suffix}</span>`);
        }

        function calculateGrowthMetrics(data) {
            const daily = {};
            data.forEach(s => {
                if(!daily[s.date]) daily[s.date] = { orders: 0, revenue: 0, profit: 0 };
                daily[s.date].orders++; daily[s.date].revenue += s.totalAmount; daily[s.date].profit += s.profit;
            });
            const sorted = Object.keys(daily).sort();
            if(sorted.length < 2) { 
                ['growthOrders','growthRevenue','growthProfit'].forEach(id => safeSetHTML(id, 'â€”')); 
                return; 
            }
            const today = daily[sorted[sorted.length-1]], yesterday = daily[sorted[sorted.length-2]];
            updateGrowthUI('growthOrders', today.orders, yesterday.orders, '');
            updateGrowthUI('growthRevenue', today.revenue, yesterday.revenue, 'â‚¹');
            updateGrowthUI('growthProfit', today.profit, yesterday.profit, 'â‚¹');
            calculateWeeklyGrowth(daily);
        }
        
        function calculateWeeklyGrowth(dailyData) {
            const dates = Object.keys(dailyData).sort();
            if (dates.length < 7) return; 

            const lastTwoWeeks = dates.slice(-14);
            const thisWeek = lastTwoWeeks.slice(-7);
            const lastWeek = lastTwoWeeks.slice(0, lastTwoWeeks.length - 7);

            const sumMetrics = (days) => days.reduce((acc, date) => {
                const day = dailyData[date] || { orders: 0, revenue: 0, profit: 0 };
                acc.orders += day.orders; 
                acc.revenue += day.revenue; 
                acc.profit += day.profit;
                return acc;
            }, { orders: 0, revenue: 0, profit: 0 });

            const current = sumMetrics(thisWeek);
            const previous = sumMetrics(lastWeek);

            const currentAOV = current.orders > 0 ? current.revenue / current.orders : 0;
            const previousAOV = previous.orders > 0 ? previous.revenue / previous.orders : 0;
            const currentAvgRev = current.revenue / thisWeek.length;
            const previousAvgRev = previous.revenue / lastWeek.length;

            updateGrowthUI('weeklyRevenueGrowth', current.revenue, previous.revenue, 'â‚¹');
            updateGrowthUI('weeklyOrderGrowth', current.orders, previous.orders, '');
            updateGrowthUI('weeklyAovGrowth', currentAOV, previousAOV, 'â‚¹');
            updateGrowthUI('weeklyAvgRevGrowth', currentAvgRev, previousAvgRev, 'â‚¹');

            const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            const periodText = `${formatDate(thisWeek[0])}-${formatDate(thisWeek[thisWeek.length-1])} vs Prev 7d`;
            
            ['weeklyRevenuePeriod', 'weeklyOrderPeriod', 'weeklyAovPeriod', 'weeklyAvgRevPeriod'].forEach(id => {
                safeSetText(id, periodText);
            });
        }

        function clearFilters() { 
            const startEl = document.getElementById('filterStartDate');
            const endEl = document.getElementById('filterEndDate');
            const restroEl = document.getElementById('filterRestro');
            if(startEl) startEl.value = ''; 
            if(endEl) endEl.value = ''; 
            if(restroEl) restroEl.value = ''; 
            updateDashboard(); 
        }

        async function generateInvoice() {
            const restroName = document.getElementById('invoiceRestro').value;
            const startDate = document.getElementById('invoiceStart').value;
            const endDate = document.getElementById('invoiceEnd').value;

            if (!restroName || !startDate || !endDate) { alert("Select filters first."); return; }
            const invoiceData = allSalesData.filter(item => item.restro === restroName && item.date >= startDate && item.date <= endDate);
            if (invoiceData.length === 0) { alert("No records."); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const primaryColor = [255, 87, 34];
            const secondaryColor = [44, 62, 80];
            
            // Load and add logo to PDF
            const logoImg = new Image();
            logoImg.crossOrigin = 'Anonymous';
            logoImg.src = 'https://i.ibb.co/qFhgyxtS/Untitled-design-4.png';
            
            await new Promise((resolve) => {
                logoImg.onload = resolve;
                logoImg.onerror = resolve;
            });

            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            // Add logo image
            try {
                doc.addImage(logoImg, 'PNG', 12, 7, 26, 26);
            } catch(e) {
                // Fallback if image fails
                doc.setFillColor(...primaryColor);
                doc.roundedRect(15, 10, 15, 15, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text("KN", 18, 20);
            }
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Khanago", 42, 22);
            doc.setFontSize(16);
            doc.text("PAYOUT STATEMENT", 195, 22, { align: "right" });

            doc.setFillColor(245, 245, 245);
            doc.rect(0, 40, 210, 25, 'F');
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("RESTAURANT", 15, 50);
            doc.text("PAYOUT PERIOD", 15, 58);
            doc.setFont("helvetica", "normal");
            doc.text(":  " + restroName.toUpperCase(), 50, 50);
            doc.text(":  " + startDate + "  to  " + endDate, 50, 58);

            let totalItemPrice = 0, totalPlatFees = 0, totalTransFees = 0, totalComm = 0, totalPayout = 0;
            const tableRows = invoiceData.map(row => {
                const transFeeAmt = (row.itemPrice * row.transactionFees) / 100;
                const commissionAmt = (row.itemPrice * (row.commission || 0)) / 100;
                const payout = row.itemPrice - row.restroPlatformFees - transFeeAmt - commissionAmt;
                totalItemPrice += row.itemPrice; totalPlatFees += row.restroPlatformFees;
                totalTransFees += transFeeAmt; totalComm += commissionAmt; totalPayout += payout;
                return [row.date, row.itemPrice.toFixed(2), row.restroPlatformFees.toFixed(2), transFeeAmt.toFixed(2), commissionAmt.toFixed(2), payout.toFixed(2)];
            });

            doc.autoTable({
                startY: 75,
                head: [['Date', 'Item Price', 'Plat Fee', 'Trans Fee', 'Comm.', 'Net Payout']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: primaryColor, halign: 'center', fontSize: 10 },
                columnStyles: { 0: { cellWidth: 30 }, 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' }, 4: { halign: 'right' }, 5: { halign: 'right', fontStyle: 'bold' } },
                styles: { fontSize: 9 }
            });

            let finalY = doc.lastAutoTable.finalY + 15;
            if (finalY > 240) { doc.addPage(); finalY = 20; }
            doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text("FINANCIAL SUMMARY", 120, finalY);
            doc.autoTable({
                startY: finalY + 5,
                margin: { left: 120 },
                body: [
                    ['Total Item Sales', "Rs " + totalItemPrice.toFixed(2)],
                    ['Total Platform Fees', "(-) Rs " + totalPlatFees.toFixed(2)],
                    ['Total Transaction Fees', "(-) Rs " + totalTransFees.toFixed(2)],
                    ['Total Commissions', "(-) Rs " + totalComm.toFixed(2)],
                    [{ content: 'NET PAYABLE AMOUNT', styles: { fontStyle: 'bold', fillColor: [255, 240, 235] } }, { content: "Rs " + totalPayout.toFixed(2), styles: { fontStyle: 'bold', textColor: primaryColor, fillColor: [255, 240, 235] } }]
                ],
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 2 },
                columnStyles: { 0: { cellWidth: 50 }, 1: { halign: 'right' } }
            });

            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8); doc.setTextColor(150, 150, 150);
            doc.text("Disclaimer: System-generated statement. Khanago Sales Tracker Pro.", 15, pageHeight - 15);
            doc.text("Generated on: " + new Date().toLocaleString(), 15, pageHeight - 10);
            doc.save(`Payout_${restroName.replace(/\s+/g, '_')}.pdf`);
        }

        function addAdjustmentRow() {
            const container = document.getElementById('adjustmentsContainer');
            const row = document.createElement('div');
            row.className = 'adjustment-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            row.innerHTML = `
                <select class="adj-type" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; width: 80px;">
                    <option value="-">- (Deduct)</option>
                    <option value="+">+ (Add)</option>
                </select>
                <input type="number" class="adj-amount" placeholder="Amount" step="0.01" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; width: 100px;">
                <input type="text" class="adj-notes" placeholder="Notes (e.g., Advance, Petrol)" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; flex: 1;">
                <button type="button" onclick="this.parentNode.remove()" style="background: #e53935; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">âœ•</button>
            `;
            container.appendChild(row);
        }

        async function generateRiderInvoice() {
            const riderName = document.getElementById('invoiceRider').value;
            const startDate = document.getElementById('riderInvoiceStart').value;
            const endDate = document.getElementById('riderInvoiceEnd').value;

            if (!riderName || !startDate || !endDate) { alert("Select rider and date range first."); return; }
            
            const invoiceData = allSalesData.filter(item => item.riderName === riderName && item.date >= startDate && item.date <= endDate);
            if (invoiceData.length === 0) { alert("No records found for this rider in selected date range."); return; }
            
            // Get adjustments
            const adjustments = [];
            document.querySelectorAll('.adjustment-row').forEach(row => {
                const type = row.querySelector('.adj-type').value;
                const amount = parseFloat(row.querySelector('.adj-amount').value) || 0;
                const notes = row.querySelector('.adj-notes').value || '';
                if (amount > 0) {
                    adjustments.push({ type, amount, notes });
                }
            });
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const primaryColor = [46, 125, 50];
            const secondaryColor = [44, 62, 80];
            
            // Load and add logo to PDF
            const logoImg = new Image();
            logoImg.crossOrigin = 'Anonymous';
            logoImg.src = 'https://i.ibb.co/qFhgyxtS/Untitled-design-4.png';
            
            await new Promise((resolve) => {
                logoImg.onload = resolve;
                logoImg.onerror = resolve;
            });

            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 40, 'F');
            
            // Add logo image
            try {
                doc.addImage(logoImg, 'PNG', 12, 7, 26, 26);
            } catch(e) {
                doc.setFillColor(...primaryColor);
                doc.roundedRect(15, 10, 15, 15, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text("KN", 18, 20);
            }
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Khanago", 42, 22);
            doc.setFontSize(16);
            doc.text("RIDER CASH STATEMENT", 195, 22, { align: "right" });

            doc.setFillColor(232, 245, 233);
            doc.rect(0, 40, 210, 25, 'F');
            doc.setTextColor(...secondaryColor);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("RIDER NAME", 15, 50);
            doc.text("STATEMENT PERIOD", 15, 58);
            doc.setFont("helvetica", "normal");
            doc.text(":  " + riderName.toUpperCase(), 55, 50);
            doc.text(":  " + startDate + "  to  " + endDate, 55, 58);

            let totalOrderAmount = 0;
            const tableRows = invoiceData.map(row => {
                totalOrderAmount += row.totalAmount;
                return [row.date, row.restro, "Rs " + row.totalAmount.toFixed(2)];
            });

            doc.autoTable({
                startY: 75,
                head: [['Date', 'Restaurant', 'Order Amount']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: primaryColor, halign: 'center', fontSize: 10 },
                columnStyles: { 0: { cellWidth: 35 }, 1: { cellWidth: 90 }, 2: { halign: 'right', fontStyle: 'bold' } },
                styles: { fontSize: 9 }
            });

            let finalY = doc.lastAutoTable.finalY + 15;
            if (finalY > 200) { doc.addPage(); finalY = 20; }
            
            // Calculate adjustments total
            let totalAdjustments = 0;
            const adjustmentRows = adjustments.map(adj => {
                const adjValue = adj.type === '-' ? -adj.amount : adj.amount;
                totalAdjustments += adjValue;
                return [adj.notes || (adj.type === '-' ? 'Deduction' : 'Addition'), adj.type + " Rs " + adj.amount.toFixed(2)];
            });
            
            const netCashInHand = totalOrderAmount + totalAdjustments;
            
            doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text("CASH SUMMARY", 120, finalY);
            
            const summaryBody = [
                ['Total Order Collections', "Rs " + totalOrderAmount.toFixed(2)]
            ];
            
            // Add adjustment rows
            adjustments.forEach(adj => {
                const sign = adj.type === '-' ? '(-)' : '(+)';
                summaryBody.push([adj.notes || (adj.type === '-' ? 'Deduction' : 'Addition'), sign + " Rs " + adj.amount.toFixed(2)]);
            });
            
            summaryBody.push([{ content: 'NET CASH IN HAND', styles: { fontStyle: 'bold', fillColor: [232, 245, 233] } }, { content: "Rs " + netCashInHand.toFixed(2), styles: { fontStyle: 'bold', textColor: primaryColor, fillColor: [232, 245, 233] } }]);
            
            doc.autoTable({
                startY: finalY + 5,
                margin: { left: 120 },
                body: summaryBody,
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 2 },
                columnStyles: { 0: { cellWidth: 50 }, 1: { halign: 'right' } }
            });

            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8); doc.setTextColor(150, 150, 150);
            doc.text("Disclaimer: System-generated statement. Khanago Sales Tracker Pro.", 15, pageHeight - 15);
            doc.text("Generated on: " + new Date().toLocaleString(), 15, pageHeight - 10);
            doc.save(`RiderCash_${riderName.replace(/\s+/g, '_')}_${startDate}_${endDate}.pdf`);
            
            // Save PDF download to database
            await _supabase.from('rider_reports').insert([{
                rider_name: riderName,
                start_date: startDate,
                end_date: endDate,
                total_collections: totalOrderAmount,
                total_adjustments: totalAdjustments,
                net_cash_in_hand: netCashInHand
            }]);
            
            // Reload reports history
            const { data: reports } = await _supabase.from('rider_reports').select('*').order('downloaded_at', { ascending: false });
            if (reports) {
                allRiderReports = reports;
                renderRiderReportHistory();
            }
            
            // Clear adjustments after generating
            document.getElementById('adjustmentsContainer').innerHTML = '';
        }

        function renderRiderReportHistory() {
            const container = document.getElementById('riderReportHistory');
            if (!allRiderReports || allRiderReports.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0;">No PDF downloads yet.</p>';
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">';
            html += '<thead><tr style="background: #f7fafc;"><th style="padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0;">Rider</th><th style="padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0;">Period</th><th style="padding: 8px; text-align: right; border-bottom: 2px solid #e2e8f0;">Cash</th><th style="padding: 8px; text-align: center; border-bottom: 2px solid #e2e8f0;">Downloaded</th></tr></thead>';
            html += '<tbody>';
            
            allRiderReports.slice(0, 10).forEach(report => {
                const downloadDate = new Date(report.downloaded_at).toLocaleDateString();
                html += `<tr style="border-bottom: 1px solid #e2e8f0;">`;
                html += `<td style="padding: 8px;">${report.rider_name}</td>`;
                html += `<td style="padding: 8px;">${report.start_date} to ${report.end_date}</td>`;
                html += `<td style="padding: 8px; text-align: right; font-weight: 600;">â‚¹${parseFloat(report.net_cash_in_hand).toFixed(2)}</td>`;
                html += `<td style="padding: 8px; text-align: center;"><span style="background: #ff6b35; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${downloadDate}</span></td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function sendRiderReportWhatsApp() {
            const riderName = document.getElementById('invoiceRider').value;
            const startDate = document.getElementById('riderInvoiceStart').value;
            const endDate = document.getElementById('riderInvoiceEnd').value;
            const whatsAppNumber = document.getElementById('riderWhatsApp').value.replace(/[^0-9]/g, '');

            if (!riderName || !startDate || !endDate) { alert("Select rider and date range first."); return; }
            if (!whatsAppNumber) { alert("Please enter WhatsApp number."); return; }
            
            const invoiceData = allSalesData.filter(item => item.riderName === riderName && item.date >= startDate && item.date <= endDate);
            if (invoiceData.length === 0) { alert("No records found for this rider in selected date range."); return; }
            
            // Get adjustments
            const adjustments = [];
            document.querySelectorAll('.adjustment-row').forEach(row => {
                const type = row.querySelector('.adj-type').value;
                const amount = parseFloat(row.querySelector('.adj-amount').value) || 0;
                const notes = row.querySelector('.adj-notes').value || '';
                if (amount > 0) {
                    adjustments.push({ type, amount, notes });
                }
            });
            
            // Calculate totals
            let totalOrderAmount = 0;
            invoiceData.forEach(row => { totalOrderAmount += row.totalAmount; });
            
            let totalAdjustments = 0;
            adjustments.forEach(adj => {
                totalAdjustments += adj.type === '-' ? -adj.amount : adj.amount;
            });
            
            const netCashInHand = totalOrderAmount + totalAdjustments;
            
            // Build WhatsApp message
            let message = `*ðŸ›µ KHANAGO RIDER CASH STATEMENT*\n`;
            message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            message += `*Rider:* ${riderName}\n`;
            message += `*Period:* ${startDate} to ${endDate}\n`;
            message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            
            message += `*ðŸ“¦ ORDER DETAILS:*\n`;
            invoiceData.forEach(row => {
                message += `${row.date} | ${row.restro} | â‚¹${row.totalAmount.toFixed(2)}\n`;
            });
            
            message += `\n*ðŸ’° SUMMARY:*\n`;
            message += `Total Collections: â‚¹${totalOrderAmount.toFixed(2)}\n`;
            
            if (adjustments.length > 0) {
                adjustments.forEach(adj => {
                    const sign = adj.type === '-' ? '(-)' : '(+)';
                    message += `${adj.notes || 'Adjustment'}: ${sign} â‚¹${adj.amount.toFixed(2)}\n`;
                });
            }
            
            message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            message += `*NET CASH IN HAND: â‚¹${netCashInHand.toFixed(2)}*\n`;
            message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            message += `\n_Generated by Khanago Sales Tracker Pro_`;
            
            hideLoader();
            
            // Open WhatsApp with message directly to the rider's number
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${whatsAppNumber}?text=${encodedMessage}`, '_blank');
            
            // Clear adjustments
            document.getElementById('adjustmentsContainer').innerHTML = '';
        }

        async function closeBusinessDay() {
            const closingDate = document.getElementById('closingDate').value;
            const statusDiv = document.getElementById('closingStatus');
            
            if (!closingDate) {
                alert('Please select a date to close.');
                return;
            }
            
            // Check if already closed
            const { data: existing } = await _supabase.from('business_closings').select('*').eq('closing_date', closingDate).single();
            if (existing) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(255, 107, 53, 0.2)';
                statusDiv.innerHTML = `<span style="color: #ffa45c;">âš ï¸ This date (${closingDate}) has already been closed on ${new Date(existing.closed_at).toLocaleString()}</span>`;
                return;
            }
            
            // Get all orders for this date
            const dayOrders = allSalesData.filter(item => item.date === closingDate);
            
            if (dayOrders.length === 0) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(255, 107, 53, 0.2)';
                statusDiv.innerHTML = `<span style="color: #ffa45c;">âš ï¸ No orders found for ${closingDate}</span>`;
                return;
            }
            
            // Get unique riders for this date
            const ridersOnDate = [...new Set(dayOrders.map(o => o.riderName).filter(r => r))];
            
            if (ridersOnDate.length === 0) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(255, 107, 53, 0.2)';
                statusDiv.innerHTML = `<span style="color: #ffa45c;">âš ï¸ No rider data found for orders on ${closingDate}</span>`;
                return;
            }
            
            if (!confirm(`Close business for ${closingDate}?\\n\\nThis will send WhatsApp reports for ${ridersOnDate.length} rider(s):\\n${ridersOnDate.join(', ')}\\n\\nTotal Orders: ${dayOrders.length}`)) {
                return;
            }
            
            showLoader();
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(37, 211, 102, 0.2)';
            statusDiv.innerHTML = `<span style="color: #25D366;">ðŸ“¤ Sending reports...</span>`;
            
            const totalRevenue = dayOrders.reduce((sum, o) => sum + o.totalAmount, 0);
            let allMessages = [];
            
            // Generate message for each rider
            for (const riderName of ridersOnDate) {
                const riderOrders = dayOrders.filter(o => o.riderName === riderName);
                const riderTotal = riderOrders.reduce((sum, o) => sum + o.totalAmount, 0);
                
                let message = `*ðŸ›µ KHANAGO RIDER CASH STATEMENT*\\n`;
                message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;
                message += `*Rider:* ${riderName}\\n`;
                message += `*Date:* ${closingDate}\\n`;
                message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;
                
                message += `*ðŸ“¦ ORDER DETAILS:*\\n`;
                riderOrders.forEach(row => {
                    message += `${row.restro} | â‚¹${row.totalAmount.toFixed(2)}\\n`;
                });
                
                message += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;
                message += `*TOTAL CASH IN HAND: â‚¹${riderTotal.toFixed(2)}*\\n`;
                message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;
                message += `\\n_Generated by Khanago Sales Tracker Pro_`;
                
                allMessages.push({ riderName, message, total: riderTotal });
                
                // Save to rider_reports (PDF download record)
                await _supabase.from('rider_reports').insert([{
                    rider_name: riderName,
                    start_date: closingDate,
                    end_date: closingDate,
                    total_collections: riderTotal,
                    total_adjustments: 0,
                    net_cash_in_hand: riderTotal
                }]);
            }
            
            // Save closing record
            await _supabase.from('business_closings').insert([{
                closing_date: closingDate,
                total_orders: dayOrders.length,
                total_revenue: totalRevenue,
                riders_notified: ridersOnDate
            }]);
            
            // Reload reports history
            const { data: reports } = await _supabase.from('rider_reports').select('*').order('downloaded_at', { ascending: false });
            if (reports) {
                allRiderReports = reports;
                renderRiderReportHistory();
            }
            
            hideLoader();
            
            // Create combined message for all riders
            let combinedMessage = `*ðŸ“Š KHANAGO DAILY CLOSING REPORT*\\n`;
            combinedMessage += `*Date:* ${closingDate}\\n`;
            combinedMessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;
            
            allMessages.forEach(m => {
                combinedMessage += `*${m.riderName}:* â‚¹${m.total.toFixed(2)}\\n`;
            });
            
            combinedMessage += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;
            combinedMessage += `*TOTAL REVENUE: â‚¹${totalRevenue.toFixed(2)}*\\n`;
            combinedMessage += `*TOTAL ORDERS: ${dayOrders.length}*\\n`;
            combinedMessage += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;
            combinedMessage += `\\n_Day closed by Khanago Sales Tracker Pro_`;
            
            // Open WhatsApp with combined message
            const encodedMessage = encodeURIComponent(combinedMessage);
            window.open(`https://wa.me/${defaultWhatsAppNumber}?text=${encodedMessage}`, '_blank');
            
            statusDiv.innerHTML = `<span style="color: #25D366;">âœ… Day closed! Sent reports for ${ridersOnDate.length} rider(s). Total: â‚¹${totalRevenue.toFixed(2)}</span>`;
        }

        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('closingDate').valueAsDate = new Date();
        // loadData() is now called after authentication
    </script>
</body>
</html>
